import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { NSystemService } from 'neutrinos-seed-services';
var NFileIOService = /** @class */ (function () {
    function NFileIOService(http) {
        var _this = this;
        this.http = http;
        this.checkFileExist = function (path, fileName, i, callback) {
            return window.resolveLocalFileSystemURL(path + fileName, function () {
                var length = 4;
                if (fileName.lastIndexOf('(') > -1) {
                    var isExist = parseInt(fileName.slice((fileName.lastIndexOf('(') + 1), fileName.lastIndexOf(')')), 10);
                    if (!isNaN(isExist)) {
                        i = isExist + 1;
                        if (i > 10 && i < 100) {
                            length += 1;
                        }
                        else if (i > 100) {
                            length += 2;
                        }
                        fileName = fileName.slice(0, (fileName.lastIndexOf('.') - length)) + ' (' + i + ')' + fileName.slice(fileName.lastIndexOf('.'));
                    }
                    else {
                        i += 1;
                        fileName = fileName.slice(0, (fileName.lastIndexOf('.'))) + fileName.slice(fileName.lastIndexOf('.'));
                        fileName = fileName.slice(0, (fileName.lastIndexOf('.'))) + ' (' + i + ')' + fileName.slice(fileName.lastIndexOf('.'));
                    }
                }
                else {
                    i += 1;
                    fileName = fileName.slice(0, (fileName.lastIndexOf('.'))) + fileName.slice(fileName.lastIndexOf('.'));
                    fileName = fileName.slice(0, (fileName.lastIndexOf('.'))) + ' (' + i + ')' + fileName.slice(fileName.lastIndexOf('.'));
                }
                return _this.checkFileExist(path, fileName, i, callback);
            }, function () {
                return callback(fileName);
            });
        };
        this.systemService = NSystemService.getInstance();
        this.appProperties = this.systemService.getVal('properties');
    }
    NFileIOService.prototype.getFileInfo = function (options) {
        var dataModelURL = this.systemService.getDataModelUrl();
        if (options.metadata) {
            dataModelURL += this.appProperties.appName + "_" + options.entityName + ".files?filter={\"metadata.key\": \"" + options.metadata.key + "\"}";
        }
        else {
            dataModelURL += this.appProperties.appName + "_" + options.entityName + ".files/" + options.fileId;
        }
        return this.http.get(dataModelURL);
    };
    NFileIOService.prototype.getFormData = function (fileUri) {
        return new Promise(function (resolve, reject) {
            window.resolveLocalFileSystemURL(fileUri, function (fileEntry) {
                fileEntry.file(function (file) {
                    var reader = new FileReader();
                    reader.onerror = function (evt) {
                        return reject(evt);
                    };
                    reader.onloadend = function (evt) {
                        var formData = new FormData();
                        var blob = new Blob([new Uint8Array(reader.result)], { type: file.type });
                        formData.append('file', blob, file.name);
                        return resolve(formData);
                    };
                    reader.readAsArrayBuffer(file);
                });
            }, function (error) {
                return reject(error);
            });
        });
    };
    NFileIOService.prototype.getPicture = function (cameraOptions) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                navigator.camera.getPicture(function (imageUri) {
                    _this.getFormData(imageUri).then(function (res) {
                        return resolve(res);
                    }).catch(function (err) { return reject(err); });
                }, function (error) {
                    return reject(error);
                }, cameraOptions);
            }, false);
        });
    };
    NFileIOService.prototype.scanPicture = function (scanOptions) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                if (scanOptions.hasOwnProperty('sourceType') && scanOptions.hasOwnProperty('doUpload')) {
                    scan.scanDoc(scanOptions.sourceType, function (imageUri) {
                        if (scanOptions.doUpload) {
                            _this.getFormData(imageUri).then(function (res) {
                                return resolve(res);
                            }).catch(function (err) { return reject(err); });
                        }
                        else {
                            resolve(imageUri);
                        }
                    }, function (error) {
                        return reject(error);
                    });
                }
                else {
                    reject('sourceType not found');
                }
            }, false);
        });
    };
    //Barcode
    NFileIOService.prototype.getBarcode = function (barcodeOptions) {
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                cordova.plugins.barcodeScanner.scan(function (result) {
                    if (result.cancelled) {
                        return reject(result);
                    }
                    else {
                        return resolve(result);
                    }
                }, function (error) {
                    return reject(error);
                }, barcodeOptions);
            }, false);
        });
    };
    //Video
    NFileIOService.prototype.getVideo = function (videoOptions) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                navigator.device.capture.captureVideo(function (mediaFiles) {
                    var imageUri = mediaFiles[0].fullPath;
                    _this.getFormData(imageUri).then(function (res) {
                        return resolve(res);
                    }).catch(function (err) { return reject(err); });
                }, function (error) {
                    return reject(error);
                }, {});
            }, false);
        });
    };
    //tts
    NFileIOService.prototype.getTts = function (ttsOptions) {
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                if (ttsOptions.hasOwnProperty('text')) {
                    TTS.speak(ttsOptions).then(function () {
                        return resolve('success');
                    }, function (reason) {
                        return reject(reason);
                    });
                }
                else {
                    reject('text not found');
                }
            }, false);
        });
    };
    //shake
    NFileIOService.prototype.getShake = function (shakeOptions) {
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                if (shakeOptions.hasOwnProperty('start') && shakeOptions.hasOwnProperty('sensitivity')) {
                    if (shakeOptions.start) {
                        shake.startWatch(function () {
                            return resolve('success');
                        }, shakeOptions.sensitivity, function () {
                            return reject('error');
                        });
                    }
                    else {
                        shake.stopWatch();
                    }
                }
                else {
                    reject('start or sensitivity not found');
                }
            }, false);
        });
    };
    //ocr
    NFileIOService.prototype.getOcr = function (ocrOptions) {
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                if (ocrOptions.hasOwnProperty('uriOrBase') && ocrOptions.hasOwnProperty('returnType')) {
                    navigator.camera.getPicture(function (imageData) {
                        textocr.recText(ocrOptions.uriOrBase, ocrOptions.returnType, imageData, function (recognizedText) {
                            return resolve(recognizedText);
                        }, function (message) {
                            return reject(message);
                        });
                    }, function (message) {
                        return reject(message);
                    }, ocrOptions);
                }
                else {
                    reject('uriOrBase or returnType not found');
                }
            }, false);
        });
    };
    //fingerprint
    NFileIOService.prototype.getFingerprint = function (fingerprintOptions) {
        return new Promise(function (resolve, reject) {
            document.addEventListener('deviceready', function () {
                if (fingerprintOptions.hasOwnProperty('clientId') && fingerprintOptions.hasOwnProperty('clientSecret')) {
                    Fingerprint.isAvailable(function (result) {
                        Fingerprint.show(fingerprintOptions, function () {
                            return resolve('success');
                        }, function (err) {
                            return reject(err);
                        });
                    }, function (message) {
                        return reject(message);
                    });
                }
                else {
                    reject('clientId or clientSecret not found');
                }
            }, false);
        });
    };
    NFileIOService.prototype.upload = function (options) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var body = new FormData();
            if (options.formData) {
                body = options.formData;
            }
            else if (options.files) {
                body.append('file', options.files);
            }
            else {
                reject('No file selected!');
            }
            if (options.metadata) {
                body.append('metadata', JSON.stringify(options.metadata));
            }
            var headers = { 'Content-Type': 'no-content' };
            var url = _this.systemService.getFileIOUrl() + ("" + options.entityName);
            var temp_headers = { headers: _this.setHeaders(headers) };
            _this.http.post(url, body, temp_headers)
                .subscribe(function (res) { return resolve(res); }, function (err) { return reject(err); });
        });
    };
    NFileIOService.prototype.download = function (options) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (options.entityName && (options.metadata || options.fileId)) {
                _this.getFileInfo(options).subscribe(function (res) {
                    if (options.metadata) {
                        res = res[res.length - 1];
                    }
                    else {
                        res = res.result;
                    }
                    var fileInfo = {
                        contentType: '',
                        filename: ''
                    };
                    if (res && res['contentType'] && res['filename']) {
                        fileInfo['contentType'] = res['contentType'];
                        fileInfo['filename'] = res['filename'];
                        var fileIOURL = _this.systemService.getFileIOUrl();
                        if (options.metadata) {
                            fileIOURL += options.entityName + "?metadataFilter={\"metadata.key\": \"" + options.metadata.key + "\"}";
                        }
                        else {
                            fileIOURL += options.entityName + "/" + options.fileId;
                        }
                        var headers = {
                            'Accept': fileInfo.contentType
                        };
                        _this.http.get(fileIOURL, { headers: _this.setHeaders(headers), responseType: 'blob' }).subscribe(function (response) {
                            var blob = new Blob([response.body], { type: fileInfo.contentType });
                            _this.saveFile(blob, fileInfo.filename).then(function (resp) {
                            }).catch(function (err) { return reject(err); });
                        }, function (err) { return reject(err); });
                    }
                    else {
                        reject('fileInfo not exit');
                    }
                }, function (err) { return reject(err); });
            }
            else {
                return reject('download options not found');
            }
        });
    };
    NFileIOService.prototype.saveFile = function (data, filename) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (_this.systemService.checkDevice() == 'mobile') {
                var storageLocation = _this.systemService.isAndroid() ? cordova.file.externalRootDirectory : cordova.file.documentsDirectory;
                _this.createDirectory(storageLocation, _this.appProperties.appName, filename, data)
                    .then(function (res) { return resolve(res); })
                    .catch(function (err) { return reject(err); });
            }
            else {
                _this.saveToBrowser(data, filename).then(function (res) { return resolve(res); });
            }
        });
    };
    NFileIOService.prototype.saveToBrowser = function (data, fileName) {
        return new Promise(function (resolve) {
            // Edge 20+
            var isEdge = !( /*@cc_on!@*/false || !!document['documentMode']) && !!window.StyleMedia;
            if (isEdge) {
                window.navigator.msSaveBlob(data, fileName);
            }
            else {
                var downloadURL = window.URL.createObjectURL(data);
                var anchor = document.createElement('a');
                document.body.appendChild(anchor);
                anchor.style.display = 'none';
                anchor.download = fileName;
                anchor.href = downloadURL;
                anchor.click();
                window.URL.revokeObjectURL(downloadURL);
                document.body.removeChild(anchor);
                anchor.remove();
            }
            return resolve('download complete');
        });
    };
    NFileIOService.prototype.createDirectory = function (rootDirectory, appName, fileName, data) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            window.resolveLocalFileSystemURL(rootDirectory, function (fileSystem) {
                fileSystem.getDirectory(appName, { create: true }, function (dirEntry) {
                    _this.checkFileExist(dirEntry.nativeURL, fileName, 0, function (newFileName) {
                        dirEntry.getFile(newFileName, { create: true }, function (targetFile) {
                            targetFile.createWriter(function (fileWriter) {
                                fileWriter.onwriteend = function () {
                                    return resolve(targetFile.toURL());
                                };
                                fileWriter.onerror = function (err) {
                                    return reject(err);
                                };
                                fileWriter.write(data);
                            });
                        });
                    });
                }, function (err) { return reject(err); });
            }, function (err) { return reject(err); });
        });
    };
    NFileIOService.prototype.setHeaders = function (headerJSON) {
        var headers = new HttpHeaders();
        for (var key in headerJSON) {
            if (key) {
                headers = headers.set(key, headerJSON[key]);
            }
        }
        return headers;
    };
    NFileIOService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    NFileIOService = __decorate([
        Injectable()
    ], NFileIOService);
    return NFileIOService;
}());
export { NFileIOService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1maWxlSU8uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1tb2R1bGUvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1tb2R1bGUvbmV1dHJpbm9zLWZpbGUvc2VydmljZXMvbi1maWxlSU8uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQWF4RDtJQUlFLHdCQUFvQixJQUFnQjtRQUFwQyxpQkFHQztRQUhtQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBc1Q1QixtQkFBYyxHQUFHLFVBQUMsSUFBWSxFQUFFLFFBQWdCLEVBQUUsQ0FBUyxFQUFFLFFBQVE7WUFDM0UsT0FBTyxNQUFNLENBQUMseUJBQXlCLENBQUMsSUFBSSxHQUFHLFFBQVEsRUFBRTtnQkFDdkQsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNmLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDbEMsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDekcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTt3QkFDbkIsQ0FBQyxHQUFHLE9BQU8sR0FBRyxDQUFDLENBQUM7d0JBQ2hCLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFOzRCQUNyQixNQUFNLElBQUks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QU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztnQ0FDckMsQ0FBQyxDQUFDO2dDQUVGLFVBQVUsQ0FBQyxPQUFPLEdBQUcsVUFBQyxHQUFHO29DQUN2QixPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQ0FDckIsQ0FBQyxDQUFDO2dDQUNGLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ3pCLENBQUMsQ0FBQyxDQUFDO3dCQUNMLENBQUMsQ0FBQyxDQUFDO29CQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsRUFBRSxVQUFBLEdBQUcsSUFBSSxPQUFBLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBWCxDQUFXLENBQUMsQ0FBQztZQUN6QixDQUFDLEVBQUUsVUFBQSxHQUFHLElBQUksT0FBQSxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQVgsQ0FBVyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBK0JPLG1DQUFVLEdBQWxCLFVBQW1CLFVBQWtCO1FBQ25DLElBQUksT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEMsS0FBSyxJQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUU7WUFDNUIsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQzdDO1NBQ0Y7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOztnQkEzVnlCLFVBQVU7O0lBSnpCLGNBQWM7UUFEMUIsVUFBVSxFQUFFO09BQ0EsY0FBYyxDQWlXMUI7SUFBRCxxQkFBQztDQUFBLEFBaldELElBaVdDO1NBaldZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBOU3lzdGVtU2VydmljZX0gZnJvbSAnbmV1dHJpbm9zLXNlZWQtc2VydmljZXMnO1xyXG5cclxuXHJcbmRlY2xhcmUgY29uc3Qgd2luZG93OiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgY29yZG92YTogYW55O1xyXG5kZWNsYXJlIGNvbnN0IG5hdmlnYXRvcjogYW55O1xyXG5kZWNsYXJlIGNvbnN0IHNjYW46IGFueTtcclxuZGVjbGFyZSBjb25zdCB0ZXh0b2NyOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgVFRTOiBhbnk7XHJcbmRlY2xhcmUgY29uc3Qgc2hha2U6IGFueTtcclxuZGVjbGFyZSBjb25zdCBGaW5nZXJwcmludDogYW55O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTkZpbGVJT1NlcnZpY2Uge1xyXG4gIHN5c3RlbVNlcnZpY2U7XHJcbiAgYXBwUHJvcGVydGllcztcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XHJcbiAgICB0aGlzLnN5c3RlbVNlcnZpY2UgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGaWxlSW5mbyhvcHRpb25zKTogYW55IHtcclxuICAgIGxldCBkYXRhTW9kZWxVUkwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0RGF0YU1vZGVsVXJsKCk7XHJcbiAgICBpZiAob3B0aW9ucy5tZXRhZGF0YSkge1xyXG4gICAgICBkYXRhTW9kZWxVUkwgKz0gYCR7dGhpcy5hcHBQcm9wZXJ0aWVzLmFwcE5hbWV9XyR7b3B0aW9ucy5lbnRpdHlOYW1lfS5maWxlcz9maWx0ZXI9e1wibWV0YWRhdGEua2V5XCI6IFwiJHtvcHRpb25zLm1ldGFkYXRhLmtleX1cIn1gO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZGF0YU1vZGVsVVJMICs9IGAke3RoaXMuYXBwUHJvcGVydGllcy5hcHBOYW1lfV8ke29wdGlvbnMuZW50aXR5TmFtZX0uZmlsZXMvJHtvcHRpb25zLmZpbGVJZH1gO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoZGF0YU1vZGVsVVJMKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Rm9ybURhdGEoZmlsZVVyaTogc3RyaW5nKTogUHJvbWlzZTxGb3JtRGF0YT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgd2luZG93LnJlc29sdmVMb2NhbEZpbGVTeXN0ZW1VUkwoZmlsZVVyaSwgKGZpbGVFbnRyeSkgPT4ge1xyXG4gICAgICAgIGZpbGVFbnRyeS5maWxlKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBldnQgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGV2dCk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9IGV2dCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbbmV3IFVpbnQ4QXJyYXkoPGFueT5yZWFkZXIucmVzdWx0KV0sIHsgdHlwZTogZmlsZS50eXBlIH0pO1xyXG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBibG9iLCBmaWxlLm5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShmb3JtRGF0YSk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9LCAoZXJyb3IpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRQaWN0dXJlKGNhbWVyYU9wdGlvbnMpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgKCkgPT4ge1xyXG4gICAgICAgIG5hdmlnYXRvci5jYW1lcmEuZ2V0UGljdHVyZSgoaW1hZ2VVcmkpID0+IHtcclxuICAgICAgICAgIHRoaXMuZ2V0Rm9ybURhdGEoaW1hZ2VVcmkpLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9LCBjYW1lcmFPcHRpb25zKTtcclxuICAgICAgfSwgZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2NhblBpY3R1cmUoc2Nhbk9wdGlvbnMpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgKCkgPT4ge1xyXG4gICAgICAgIGlmKHNjYW5PcHRpb25zLmhhc093blByb3BlcnR5KCdzb3VyY2VUeXBlJykgJiYgc2Nhbk9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ2RvVXBsb2FkJykpIHtcclxuICAgICAgICAgIHNjYW4uc2NhbkRvYyhzY2FuT3B0aW9ucy5zb3VyY2VUeXBlLCAoaW1hZ2VVcmkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNjYW5PcHRpb25zLmRvVXBsb2FkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldEZvcm1EYXRhKGltYWdlVXJpKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlcyk7XHJcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShpbWFnZVVyaSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZWplY3QoJ3NvdXJjZVR5cGUgbm90IGZvdW5kJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCBmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4vL0JhcmNvZGVcclxuICBwdWJsaWMgZ2V0QmFyY29kZShiYXJjb2RlT3B0aW9ucykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCAoKSA9PiB7XHJcbiAgICAgICAgY29yZG92YS5wbHVnaW5zLmJhcmNvZGVTY2FubmVyLnNjYW4oKHJlc3VsdCk9PiB7XHJcbiAgICAgICAgICBpZihyZXN1bHQuY2FuY2VsbGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZWplY3QocmVzdWx0KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSwgKGVycm9yKT0+IHtcclxuICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgIH0sIGJhcmNvZGVPcHRpb25zKTtcclxuICAgICAgfSwgZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuLy9WaWRlb1xyXG4gIHB1YmxpYyBnZXRWaWRlbyh2aWRlb09wdGlvbnMpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgKCkgPT4ge1xyXG4gICAgICAgIG5hdmlnYXRvci5kZXZpY2UuY2FwdHVyZS5jYXB0dXJlVmlkZW8oKG1lZGlhRmlsZXMpID0+IHtcclxuICAgICAgICAgIHZhciBpbWFnZVVyaSA9IG1lZGlhRmlsZXNbMF0uZnVsbFBhdGg7ICAgICAgICBcclxuICAgICAgICAgIHRoaXMuZ2V0Rm9ybURhdGEoaW1hZ2VVcmkpLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9LCB7fSk7XHJcbiAgICAgIH0sIGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbi8vdHRzXHJcbiAgcHVibGljIGdldFR0cyh0dHNPcHRpb25zKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VyZWFkeScsICgpID0+IHtcclxuICAgICAgICBpZih0dHNPcHRpb25zLmhhc093blByb3BlcnR5KCd0ZXh0JykpIHtcclxuICAgICAgICAgIFRUUy5zcGVhayh0dHNPcHRpb25zKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoJ3N1Y2Nlc3MnKTtcclxuICAgICAgICAgIH0sIChyZWFzb24pID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChyZWFzb24pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdCgndGV4dCBub3QgZm91bmQnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbi8vc2hha2VcclxuICBwdWJsaWMgZ2V0U2hha2Uoc2hha2VPcHRpb25zKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VyZWFkeScsICgpID0+IHtcclxuICAgICAgICBpZihzaGFrZU9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3N0YXJ0JykgJiYgc2hha2VPcHRpb25zLmhhc093blByb3BlcnR5KCdzZW5zaXRpdml0eScpKSB7XHJcbiAgICAgICAgICBpZihzaGFrZU9wdGlvbnMuc3RhcnQpIHtcclxuICAgICAgICAgICAgc2hha2Uuc3RhcnRXYXRjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoJ3N1Y2Nlc3MnKTtcclxuICAgICAgICAgICAgfSwgc2hha2VPcHRpb25zLnNlbnNpdGl2aXR5LCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdCgnZXJyb3InKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzaGFrZS5zdG9wV2F0Y2goKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KCdzdGFydCBvciBzZW5zaXRpdml0eSBub3QgZm91bmQnKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbi8vb2NyXHJcbiAgcHVibGljIGdldE9jcihvY3JPcHRpb25zKSB7XHJcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCAoKSA9PiB7XHJcbiAgICAgICAgICBpZihvY3JPcHRpb25zLmhhc093blByb3BlcnR5KCd1cmlPckJhc2UnKSAmJiBvY3JPcHRpb25zLmhhc093blByb3BlcnR5KCdyZXR1cm5UeXBlJykpIHtcclxuICAgICAgICAgICAgbmF2aWdhdG9yLmNhbWVyYS5nZXRQaWN0dXJlKChpbWFnZURhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIHRleHRvY3IucmVjVGV4dChvY3JPcHRpb25zLnVyaU9yQmFzZSwgb2NyT3B0aW9ucy5yZXR1cm5UeXBlLCBpbWFnZURhdGEsIChyZWNvZ25pemVkVGV4dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVjb2duaXplZFRleHQpO1xyXG4gICAgICAgICAgICAgIH0sIChtZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LCAobWVzc2FnZSkgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QobWVzc2FnZSk7XHJcbiAgICAgICAgICAgIH0sIG9jck9wdGlvbnMpOyBcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlamVjdCgndXJpT3JCYXNlIG9yIHJldHVyblR5cGUgbm90IGZvdW5kJyk7XHJcbiAgICAgICAgICB9XHJcbiBcclxuICAgICAgICB9LCBmYWxzZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG5cclxuLy9maW5nZXJwcmludFxyXG4gIHB1YmxpYyBnZXRGaW5nZXJwcmludChmaW5nZXJwcmludE9wdGlvbnMpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgKCkgPT4ge1xyXG4gICAgICAgIGlmKGZpbmdlcnByaW50T3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnY2xpZW50SWQnKSAmJiBmaW5nZXJwcmludE9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ2NsaWVudFNlY3JldCcpKSB7XHJcbiAgICAgICAgICBGaW5nZXJwcmludC5pc0F2YWlsYWJsZSgocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIEZpbmdlcnByaW50LnNob3coZmluZ2VycHJpbnRPcHRpb25zLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoJ3N1Y2Nlc3MnKTtcclxuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9LCAobWVzc2FnZSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KG1lc3NhZ2UpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlamVjdCgnY2xpZW50SWQgb3IgY2xpZW50U2VjcmV0IG5vdCBmb3VuZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSwgZmFsc2UpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgdXBsb2FkKG9wdGlvbnMpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgbGV0IGJvZHk6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICAgIGlmIChvcHRpb25zLmZvcm1EYXRhKSB7XHJcbiAgICAgICAgYm9keSA9IG9wdGlvbnMuZm9ybURhdGE7XHJcbiAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5maWxlcykge1xyXG4gICAgICAgIGJvZHkuYXBwZW5kKCdmaWxlJywgb3B0aW9ucy5maWxlcyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVqZWN0KCdObyBmaWxlIHNlbGVjdGVkIScpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChvcHRpb25zLm1ldGFkYXRhKSB7XHJcbiAgICAgICAgYm9keS5hcHBlbmQoJ21ldGFkYXRhJywgSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5tZXRhZGF0YSkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBoZWFkZXJzID0geyAnQ29udGVudC1UeXBlJzogJ25vLWNvbnRlbnQnIH07XHJcbiAgICAgIGNvbnN0IHVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRGaWxlSU9VcmwoKSArIGAke29wdGlvbnMuZW50aXR5TmFtZX1gO1xyXG4gICAgICBsZXQgdGVtcF9oZWFkZXJzID0geyBoZWFkZXJzOiB0aGlzLnNldEhlYWRlcnMoaGVhZGVycykgfVxyXG4gICAgICB0aGlzLmh0dHAucG9zdCh1cmwsIGJvZHksIHRlbXBfaGVhZGVycylcclxuICAgICAgICAuc3Vic2NyaWJlKHJlcyA9PiByZXNvbHZlKHJlcylcclxuICAgICAgICAsIGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkb3dubG9hZChvcHRpb25zOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKG9wdGlvbnMuZW50aXR5TmFtZSAmJiAob3B0aW9ucy5tZXRhZGF0YSB8fCBvcHRpb25zLmZpbGVJZCkpIHtcclxuICAgICAgICB0aGlzLmdldEZpbGVJbmZvKG9wdGlvbnMpLnN1YnNjcmliZSgocmVzKSA9PiB7XHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5tZXRhZGF0YSkge1xyXG4gICAgICAgICAgICByZXMgPSByZXNbcmVzLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzID0gcmVzLnJlc3VsdDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGZpbGVJbmZvID0ge1xyXG4gICAgICAgICAgICBjb250ZW50VHlwZTogJycsXHJcbiAgICAgICAgICAgIGZpbGVuYW1lOiAnJ1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGlmIChyZXMgJiYgcmVzWydjb250ZW50VHlwZSddICYmIHJlc1snZmlsZW5hbWUnXSkge1xyXG4gICAgICAgICAgICBmaWxlSW5mb1snY29udGVudFR5cGUnXSA9IHJlc1snY29udGVudFR5cGUnXTtcclxuICAgICAgICAgICAgZmlsZUluZm9bJ2ZpbGVuYW1lJ10gPSByZXNbJ2ZpbGVuYW1lJ107XHJcbiAgICAgICAgICAgIGxldCBmaWxlSU9VUkwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0RmlsZUlPVXJsKCk7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLm1ldGFkYXRhKSB7XHJcbiAgICAgICAgICAgICAgZmlsZUlPVVJMICs9IGAke29wdGlvbnMuZW50aXR5TmFtZX0/bWV0YWRhdGFGaWx0ZXI9e1wibWV0YWRhdGEua2V5XCI6IFwiJHtvcHRpb25zLm1ldGFkYXRhLmtleX1cIn1gO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGZpbGVJT1VSTCArPSBgJHtvcHRpb25zLmVudGl0eU5hbWV9LyR7b3B0aW9ucy5maWxlSWR9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBoZWFkZXJzID0ge1xyXG4gICAgICAgICAgICAgICdBY2NlcHQnOiBmaWxlSW5mby5jb250ZW50VHlwZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB0aGlzLmh0dHAuZ2V0KGZpbGVJT1VSTCwgeyBoZWFkZXJzOiB0aGlzLnNldEhlYWRlcnMoaGVhZGVycyksIHJlc3BvbnNlVHlwZTogJ2Jsb2InIH0pLnN1YnNjcmliZSgocmVzcG9uc2U6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbcmVzcG9uc2UuYm9keV0sIHsgdHlwZTogZmlsZUluZm8uY29udGVudFR5cGUgfSk7XHJcbiAgICAgICAgICAgICAgdGhpcy5zYXZlRmlsZShibG9iLCBmaWxlSW5mby5maWxlbmFtZSkudGhlbigocmVzcCkgPT4ge1xyXG4gICAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgICAgIH0sIGVyciA9PiByZWplY3QoZXJyKSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZWplY3QoJ2ZpbGVJbmZvIG5vdCBleGl0Jyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSwgZXJyID0+IHJlamVjdChlcnIpKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KCdkb3dubG9hZCBvcHRpb25zIG5vdCBmb3VuZCcpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzYXZlRmlsZShkYXRhOiBCbG9iLCBmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLnN5c3RlbVNlcnZpY2UuY2hlY2tEZXZpY2UoKSA9PSAnbW9iaWxlJykge1xyXG4gICAgICAgIGNvbnN0IHN0b3JhZ2VMb2NhdGlvbiA9IHRoaXMuc3lzdGVtU2VydmljZS5pc0FuZHJvaWQoKSA/IGNvcmRvdmEuZmlsZS5leHRlcm5hbFJvb3REaXJlY3RvcnkgOiBjb3Jkb3ZhLmZpbGUuZG9jdW1lbnRzRGlyZWN0b3J5O1xyXG4gICAgICAgIHRoaXMuY3JlYXRlRGlyZWN0b3J5KHN0b3JhZ2VMb2NhdGlvbiwgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcE5hbWUsIGZpbGVuYW1lLCBkYXRhKVxyXG4gICAgICAgICAgLnRoZW4ocmVzID0+IHJlc29sdmUocmVzKSlcclxuICAgICAgICAgIC5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuc2F2ZVRvQnJvd3NlcihkYXRhLCBmaWxlbmFtZSkudGhlbihyZXMgPT4gcmVzb2x2ZShyZXMpKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNhdmVUb0Jyb3dzZXIoZGF0YTogQmxvYiwgZmlsZU5hbWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIC8vIEVkZ2UgMjArXHJcbiAgICAgIGNvbnN0IGlzRWRnZSA9ICEoLypAY2Nfb24hQCovZmFsc2UgfHwgISFkb2N1bWVudFsnZG9jdW1lbnRNb2RlJ10pICYmICEhd2luZG93LlN0eWxlTWVkaWE7XHJcbiAgICAgIGlmIChpc0VkZ2UpIHtcclxuICAgICAgICB3aW5kb3cubmF2aWdhdG9yLm1zU2F2ZUJsb2IoZGF0YSwgZmlsZU5hbWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGRvd25sb2FkVVJMID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoZGF0YSk7XHJcbiAgICAgICAgY29uc3QgYW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYW5jaG9yKTtcclxuICAgICAgICBhbmNob3Iuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICBhbmNob3IuZG93bmxvYWQgPSBmaWxlTmFtZTtcclxuICAgICAgICBhbmNob3IuaHJlZiA9IGRvd25sb2FkVVJMO1xyXG4gICAgICAgIGFuY2hvci5jbGljaygpO1xyXG4gICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKGRvd25sb2FkVVJMKTtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGFuY2hvcik7XHJcbiAgICAgICAgYW5jaG9yLnJlbW92ZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXNvbHZlKCdkb3dubG9hZCBjb21wbGV0ZScpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZURpcmVjdG9yeShyb290RGlyZWN0b3J5OiBhbnksIGFwcE5hbWU6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgZGF0YTogQmxvYikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgd2luZG93LnJlc29sdmVMb2NhbEZpbGVTeXN0ZW1VUkwocm9vdERpcmVjdG9yeSwgKGZpbGVTeXN0ZW0pID0+IHtcclxuICAgICAgICBmaWxlU3lzdGVtLmdldERpcmVjdG9yeShhcHBOYW1lLCB7IGNyZWF0ZTogdHJ1ZSB9LCAoZGlyRW50cnkpID0+IHtcclxuICAgICAgICAgIHRoaXMuY2hlY2tGaWxlRXhpc3QoZGlyRW50cnkubmF0aXZlVVJMLCBmaWxlTmFtZSwgMCwgKG5ld0ZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIGRpckVudHJ5LmdldEZpbGUobmV3RmlsZU5hbWUsIHsgY3JlYXRlOiB0cnVlIH0sICh0YXJnZXRGaWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGFyZ2V0RmlsZS5jcmVhdGVXcml0ZXIoKGZpbGVXcml0ZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIGZpbGVXcml0ZXIub253cml0ZWVuZCA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodGFyZ2V0RmlsZS50b1VSTCgpKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgZmlsZVdyaXRlci5vbmVycm9yID0gKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgZmlsZVdyaXRlci53cml0ZShkYXRhKTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9LCBlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgICB9LCBlcnIgPT4gcmVqZWN0KGVycikpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrRmlsZUV4aXN0ID0gKHBhdGg6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgaTogbnVtYmVyLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgcmV0dXJuIHdpbmRvdy5yZXNvbHZlTG9jYWxGaWxlU3lzdGVtVVJMKHBhdGggKyBmaWxlTmFtZSwgKCkgPT4ge1xyXG4gICAgICBsZXQgbGVuZ3RoID0gNDtcclxuICAgICAgaWYgKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcoJykgPiAtMSkge1xyXG4gICAgICAgIGNvbnN0IGlzRXhpc3QgPSBwYXJzZUludChmaWxlTmFtZS5zbGljZSgoZmlsZU5hbWUubGFzdEluZGV4T2YoJygnKSArIDEpLCBmaWxlTmFtZS5sYXN0SW5kZXhPZignKScpKSwgMTApO1xyXG4gICAgICAgIGlmICghaXNOYU4oaXNFeGlzdCkpIHtcclxuICAgICAgICAgIGkgPSBpc0V4aXN0ICsgMTtcclxuICAgICAgICAgIGlmIChpID4gMTAgJiYgaSA8IDEwMCkge1xyXG4gICAgICAgICAgICBsZW5ndGggKz0gMTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoaSA+IDEwMCkge1xyXG4gICAgICAgICAgICBsZW5ndGggKz0gMjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc2xpY2UoMCwgKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykgLSBsZW5ndGgpKSArICcgKCcgKyBpICsgJyknICsgZmlsZU5hbWUuc2xpY2UoZmlsZU5hbWUubGFzdEluZGV4T2YoJy4nKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGkgKz0gMTtcclxuICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc2xpY2UoMCwgKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpKSArIGZpbGVOYW1lLnNsaWNlKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpO1xyXG4gICAgICAgICAgZmlsZU5hbWUgPSBmaWxlTmFtZS5zbGljZSgwLCAoZmlsZU5hbWUubGFzdEluZGV4T2YoJy4nKSkpICsgJyAoJyArIGkgKyAnKScgKyBmaWxlTmFtZS5zbGljZShmaWxlTmFtZS5sYXN0SW5kZXhPZignLicpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaSArPSAxO1xyXG4gICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc2xpY2UoMCwgKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpKSArIGZpbGVOYW1lLnNsaWNlKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpO1xyXG4gICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc2xpY2UoMCwgKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykpKSArICcgKCcgKyBpICsgJyknICsgZmlsZU5hbWUuc2xpY2UoZmlsZU5hbWUubGFzdEluZGV4T2YoJy4nKSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuY2hlY2tGaWxlRXhpc3QocGF0aCwgZmlsZU5hbWUsIGksIGNhbGxiYWNrKTtcclxuICAgIH0sICgpID0+IHtcclxuICAgICAgcmV0dXJuIGNhbGxiYWNrKGZpbGVOYW1lKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRIZWFkZXJzKGhlYWRlckpTT046IE9iamVjdCk6IEh0dHBIZWFkZXJzIHtcclxuICAgIGxldCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XHJcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBoZWFkZXJKU09OKSB7XHJcbiAgICAgIGlmIChrZXkpIHtcclxuICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoa2V5LCBoZWFkZXJKU09OW2tleV0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGVhZGVycztcclxuICB9XHJcblxyXG59XHJcbiJdfQ==