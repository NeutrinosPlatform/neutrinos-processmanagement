import { __decorate } from "tslib";
import { HttpClient } from '@angular/common/http';
import { throwError } from 'rxjs';
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { map, catchError } from 'rxjs/operators';
let NDataModelService = class NDataModelService {
    constructor(http) {
        this.http = http;
        this.invalidDataModelName = 'Invalid data model name.';
        this.invalidDataModelId = 'Invalid data model id.';
        this.invalidDataModelObj = 'Invalid data model object.';
        this.systemService = NSystemService.getInstance();
    }
    // GET /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName
     * @param filter The filter query parameter allows to specify conditions on the documents to return.
     * The filter qparam value is any mongodb queryâ€¦ Defaults to {}
     * @param keys Projections to be applited on mongo db.
     * @param sort sort to be applied on the query results. Defaults to {}
     * @param pagenumber Page number for paginated queries. Defaults to 1
     * @param pagesize Size of each page to be returned. Defaults to 100.
     */
    get(dataModelName, filter, keys, sort, pagenumber, pagesize) {
        if (dataModelName) {
            // let modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            let modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) || this.checkIfValid(keys) || this.checkIfValid(sort) ||
                this.checkIfValid(pagenumber) || this.checkIfValid(pagesize)) {
                let queryString = `${this.toQueryString({
                    'filter': filter,
                    'keys': keys,
                    'sort': sort,
                    'pagenumber': pagenumber,
                    'pagesize': pagesize
                })}`;
                if (queryString === '') {
                    queryString += '?filter={}';
                }
                else {
                    queryString = '?'.concat(queryString);
                }
                modelNameUrl += queryString;
            }
            return this.http.get(modelNameUrl).pipe(map((value, index) => {
                return value;
            }), catchError(error => {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error(`Could not get ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    // PUT /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName Data model name of the app
     * @param dataModelObj Data Model object which is to be inserted
     */
    put(dataModelName, dataModelObj) {
        if (dataModelName) {
            if (dataModelObj) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
                const modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
                return this.http.put(modelNameUrl, dataModelObj).pipe(map((value, index) => {
                    return value;
                }), catchError(error => {
                    return throwError(error);
                }));
            }
            else {
                return throwError(new Error(`Could not put ${dataModelObj} in ${dataModelName}. ${this.invalidDataModelObj}`));
            }
        }
        else {
            return throwError(new Error(`Could not put ${dataModelObj} in ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    // DELETE /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName
     * @param filter
     */
    delete(dataModelName, filter) {
        let modelNameUrl;
        if (dataModelName) {
            // modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) && filter != '') {
                modelNameUrl += `?filter=${filter}`;
            }
            else {
                modelNameUrl += '?filter={}';
            }
            return this.http.delete(modelNameUrl).pipe(map((value, index) => {
                return value;
            }), catchError(error => {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error(`Could not delete ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    // PATCH /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName Data model name which is to be updated
     * @param dataModelObj New data model object
     */
    update(dataModelName, updateObject) {
        if (dataModelName && updateObject) {
            // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            const modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            return this.http.patch(modelNameUrl, updateObject).pipe(map((value, index) => {
                return value;
            }), catchError(error => {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error(`Could not update ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    // GET /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be updated
     * @param dataModelId Data model id which is to be updated
     */
    getById(dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.get(modelNameUrl).pipe(map((value, index) => {
                    return value;
                }), catchError(error => {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            throwError(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    // DELETE /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be deleted
     * @param dataModelId Data model id which is to be deleted
     */
    deleteById(dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.delete(modelNameUrl).pipe(map((value, index) => {
                    return value;
                }), catchError(error => {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            return throwError(new Error(`Could not delete ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    //PATCH /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be update
     * @param dataModelId Data model id which is to be updated
     * @param dataModelObj Data Model object which is to be inserted
     */
    updateById(dataModelName, dataModelId, dataModelObj) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                var dmObj = Object.assign({}, dataModelObj);
                delete dmObj['_id'];
                return this.http.patch(modelNameUrl, dmObj).pipe(map((value, index) => {
                    return value;
                }), catchError(error => {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            return throwError(new Error(`Could not delete ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    toQueryString(obj) {
        const parts = [];
        for (const i in obj) {
            if (obj.hasOwnProperty(i) && this.checkIfValid(obj[i])) {
                parts.push((i) + '=' + JSON.stringify(obj[i]));
            }
        }
        return parts.join('&');
    }
    checkIfValid(value) {
        if (value === undefined || value == null) {
            return false;
        }
        else {
            return true;
        }
    }
    getDataSourceURL(dataModelName) {
        if (!this.dmDs) {
            this.dmDs = window['neutrinos']['dataSource'];
        }
        const dsDm = this.dmDs[dataModelName];
        const properties = this.systemService.properties;
        if (dsDm) {
            return properties.baseUrl + properties.tenantName + '/datamodel/' + dsDm + '/' + properties.appName + '/';
        }
        else {
            return this.systemService.getDataModelUrl();
        }
    }
};
NDataModelService.ctorParameters = () => [
    { type: HttpClient }
];
NDataModelService = __decorate([
    Injectable()
], NDataModelService);
export { NDataModelService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1kYXRhTW9kZWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWRhdGFNb2RlbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR2pELElBQWEsaUJBQWlCLEdBQTlCLE1BQWEsaUJBQWlCO0lBTzVCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFKNUIseUJBQW9CLEdBQVcsMEJBQTBCLENBQUM7UUFDMUQsdUJBQWtCLEdBQVcsd0JBQXdCLENBQUM7UUFDdEQsd0JBQW1CLEdBQVcsNEJBQTRCLENBQUM7UUFHakUsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEQsQ0FBQztJQUVELHFFQUFxRTtJQUNyRTs7Ozs7Ozs7O09BU0c7SUFDSCxHQUFHLENBQUMsYUFBYSxFQUFFLE1BQU8sRUFBRSxJQUFLLEVBQUUsSUFBSyxFQUFFLFVBQVcsRUFBRSxRQUFTO1FBQzlELElBQUksYUFBYSxFQUFFO1lBQ2pCLGdGQUFnRjtZQUNoRixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDO1lBQ3hFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxD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LENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUMvQztRQUNELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7UUFDakQsSUFBSSxJQUFJLEVBQUU7WUFDUixPQUFPLFVBQVUsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsR0FBRyxhQUFhLEdBQUcsSUFBSSxHQUFHLEdBQUcsR0FBRyxVQUFVLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztTQUMzRzthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsRUFBRSxDQUFDO1NBQzdDO0lBQ0gsQ0FBQztDQUdGLENBQUE7O1lBL04yQixVQUFVOztBQVB6QixpQkFBaUI7SUFEN0IsVUFBVSxFQUFFO0dBQ0EsaUJBQWlCLENBc083QjtTQXRPWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBtYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBORGF0YU1vZGVsU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzeXN0ZW1TZXJ2aWNlOiBOU3lzdGVtU2VydmljZTtcclxuICBwcml2YXRlIGRtVXJsOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBpbnZhbGlkRGF0YU1vZGVsTmFtZTogc3RyaW5nID0gJ0ludmFsaWQgZGF0YSBtb2RlbCBuYW1lLic7XHJcbiAgcHJpdmF0ZSBpbnZhbGlkRGF0YU1vZGVsSWQ6IHN0cmluZyA9ICdJbnZhbGlkIGRhdGEgbW9kZWwgaWQuJztcclxuICBwcml2YXRlIGludmFsaWREYXRhTW9kZWxPYmo6IHN0cmluZyA9ICdJbnZhbGlkIGRhdGEgbW9kZWwgb2JqZWN0Lic7XHJcbiAgcHJpdmF0ZSBkbURzO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xyXG4gICAgdGhpcy5zeXN0ZW1TZXJ2aWNlID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICB9XHJcblxyXG4gIC8vIEdFVCAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWVcclxuICAgKiBAcGFyYW0gZmlsdGVyIFRoZSBmaWx0ZXIgcXVlcnkgcGFyYW1ldGVyIGFsbG93cyB0byBzcGVjaWZ5IGNvbmRpdGlvbnMgb24gdGhlIGRvY3VtZW50cyB0byByZXR1cm4uXHJcbiAgICogVGhlIGZpbHRlciBxcGFyYW0gdmFsdWUgaXMgYW55IG1vbmdvZGIgcXVlcnnigKYgRGVmYXVsdHMgdG8ge31cclxuICAgKiBAcGFyYW0ga2V5cyBQcm9qZWN0aW9ucyB0byBiZSBhcHBsaXRlZCBvbiBtb25nbyBkYi5cclxuICAgKiBAcGFyYW0gc29ydCBzb3J0IHRvIGJlIGFwcGxpZWQgb24gdGhlIHF1ZXJ5IHJlc3VsdHMuIERlZmF1bHRzIHRvIHt9XHJcbiAgICogQHBhcmFtIHBhZ2VudW1iZXIgUGFnZSBudW1iZXIgZm9yIHBhZ2luYXRlZCBxdWVyaWVzLiBEZWZhdWx0cyB0byAxXHJcbiAgICogQHBhcmFtIHBhZ2VzaXplIFNpemUgb2YgZWFjaCBwYWdlIHRvIGJlIHJldHVybmVkLiBEZWZhdWx0cyB0byAxMDAuXHJcbiAgICovXHJcbiAgZ2V0KGRhdGFNb2RlbE5hbWUsIGZpbHRlcj8sIGtleXM/LCBzb3J0PywgcGFnZW51bWJlcj8sIHBhZ2VzaXplPyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xyXG4gICAgICAvLyBsZXQgbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX1gO1xyXG4gICAgICBsZXQgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZTtcclxuICAgICAgaWYgKHRoaXMuY2hlY2tJZlZhbGlkKGZpbHRlcikgfHwgdGhpcy5jaGVja0lmVmFsaWQoa2V5cykgfHwgdGhpcy5jaGVja0lmVmFsaWQoc29ydCkgfHxcclxuICAgICAgICB0aGlzLmNoZWNrSWZWYWxpZChwYWdlbnVtYmVyKSB8fCB0aGlzLmNoZWNrSWZWYWxpZChwYWdlc2l6ZSkpIHtcclxuICAgICAgICBsZXQgcXVlcnlTdHJpbmcgPSBgJHt0aGlzLnRvUXVlcnlTdHJpbmcoe1xyXG4gICAgICAgICAgJ2ZpbHRlcic6IGZpbHRlcixcclxuICAgICAgICAgICdrZXlzJzoga2V5cyxcclxuICAgICAgICAgICdzb3J0Jzogc29ydCxcclxuICAgICAgICAgICdwYWdlbnVtYmVyJzogcGFnZW51bWJlcixcclxuICAgICAgICAgICdwYWdlc2l6ZSc6IHBhZ2VzaXplXHJcbiAgICAgICAgfSl9YDtcclxuICAgICAgICBpZiAocXVlcnlTdHJpbmcgPT09ICcnKSB7XHJcbiAgICAgICAgICBxdWVyeVN0cmluZyArPSAnP2ZpbHRlcj17fSc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHF1ZXJ5U3RyaW5nID0gJz8nLmNvbmNhdChxdWVyeVN0cmluZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG1vZGVsTmFtZVVybCArPSBxdWVyeVN0cmluZztcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5odHRwLmdldChtb2RlbE5hbWVVcmwpLnBpcGUobWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XHJcbiAgICAgIH0pKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGdldCAke2RhdGFNb2RlbE5hbWV9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUFVUIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgb2YgdGhlIGFwcFxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxPYmogRGF0YSBNb2RlbCBvYmplY3Qgd2hpY2ggaXMgdG8gYmUgaW5zZXJ0ZWRcclxuICAgKi9cclxuICBwdXQoZGF0YU1vZGVsTmFtZSwgZGF0YU1vZGVsT2JqKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChkYXRhTW9kZWxOYW1lKSB7XHJcbiAgICAgIGlmIChkYXRhTW9kZWxPYmopIHtcclxuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XHJcbiAgICAgICAgY29uc3QgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZTtcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnB1dChtb2RlbE5hbWVVcmwsIGRhdGFNb2RlbE9iaikucGlwZShtYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IobmV3IEVycm9yKGBDb3VsZCBub3QgcHV0ICR7ZGF0YU1vZGVsT2JqfSBpbiAke2RhdGFNb2RlbE5hbWV9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE9ian1gKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IHB1dCAke2RhdGFNb2RlbE9ian0gaW4gJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIERFTEVURSAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWVcclxuICAgKiBAcGFyYW0gZmlsdGVyXHJcbiAgICovXHJcbiAgZGVsZXRlKGRhdGFNb2RlbE5hbWUsIGZpbHRlcik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBsZXQgbW9kZWxOYW1lVXJsO1xyXG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcclxuICAgICAgLy8gbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX1gO1xyXG4gICAgICBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lO1xyXG5cclxuICAgICAgaWYgKHRoaXMuY2hlY2tJZlZhbGlkKGZpbHRlcikgJiYgZmlsdGVyICE9ICcnKSB7XHJcbiAgICAgICAgbW9kZWxOYW1lVXJsICs9IGA/ZmlsdGVyPSR7ZmlsdGVyfWA7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbW9kZWxOYW1lVXJsICs9ICc/ZmlsdGVyPXt9JztcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZShtb2RlbE5hbWVVcmwpLnBpcGUobWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XHJcbiAgICAgIH0pKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGRlbGV0ZSAke2RhdGFNb2RlbE5hbWV9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUEFUQ0ggL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lIERhdGEgbW9kZWwgbmFtZSB3aGljaCBpcyB0byBiZSB1cGRhdGVkXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE9iaiBOZXcgZGF0YSBtb2RlbCBvYmplY3RcclxuICAgKi9cclxuICB1cGRhdGUoZGF0YU1vZGVsTmFtZSwgdXBkYXRlT2JqZWN0KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChkYXRhTW9kZWxOYW1lICYmIHVwZGF0ZU9iamVjdCkge1xyXG4gICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XHJcbiAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWU7XHJcbiAgICAgIHJldHVybiB0aGlzLmh0dHAucGF0Y2gobW9kZWxOYW1lVXJsLCB1cGRhdGVPYmplY3QpLnBpcGUobWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XHJcbiAgICAgIH0pKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IHVwZGF0ZSAke2RhdGFNb2RlbE5hbWV9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gR0VUIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9L3tkYXRhTW9kZWxJZH1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lIERhdGEgbW9kZWwgbmFtZSB3aGljaCBpcyB0byBiZSB1cGRhdGVkXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbElkIERhdGEgbW9kZWwgaWQgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxyXG4gICAqL1xyXG4gIGdldEJ5SWQoZGF0YU1vZGVsTmFtZSwgZGF0YU1vZGVsSWQpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcclxuICAgICAgaWYgKGRhdGFNb2RlbElkKSB7XHJcbiAgICAgICAgLy8gY29uc3QgbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX0vJHtkYXRhTW9kZWxJZH1gO1xyXG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWUgKyBcIi9cIiArIGRhdGFNb2RlbElkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KG1vZGVsTmFtZVVybCkucGlwZShtYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGdldCAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbElkfWApKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIERFTEVURSAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfS97ZGF0YU1vZGVsSWR9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgZGVsZXRlZFxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxJZCBEYXRhIG1vZGVsIGlkIHdoaWNoIGlzIHRvIGJlIGRlbGV0ZWRcclxuICAgKi9cclxuICBkZWxldGVCeUlkKGRhdGFNb2RlbE5hbWUsIGRhdGFNb2RlbElkKSB7XHJcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xyXG4gICAgICBpZiAoZGF0YU1vZGVsSWQpIHtcclxuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfS8ke2RhdGFNb2RlbElkfWA7XHJcbiAgICAgICAgY29uc3QgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZSArIFwiL1wiICsgZGF0YU1vZGVsSWQ7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUobW9kZWxOYW1lVXJsKS5waXBlKG1hcCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSksIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxJZH1gKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGRlbGV0ZSAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy9QQVRDSCAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfS97ZGF0YU1vZGVsSWR9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgdXBkYXRlXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbElkIERhdGEgbW9kZWwgaWQgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxPYmogRGF0YSBNb2RlbCBvYmplY3Qgd2hpY2ggaXMgdG8gYmUgaW5zZXJ0ZWRcclxuICAgKi9cclxuICB1cGRhdGVCeUlkKGRhdGFNb2RlbE5hbWUsIGRhdGFNb2RlbElkLCBkYXRhTW9kZWxPYmopIHtcclxuICAgIGlmIChkYXRhTW9kZWxOYW1lKSB7XHJcbiAgICAgIGlmIChkYXRhTW9kZWxJZCkge1xyXG4gICAgICAgIC8vIGNvbnN0IG1vZGVsTmFtZVVybCA9IGAke3RoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKX0ke2RhdGFNb2RlbE5hbWV9LyR7ZGF0YU1vZGVsSWR9YDtcclxuICAgICAgICBjb25zdCBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lICsgXCIvXCIgKyBkYXRhTW9kZWxJZDtcclxuICAgICAgICB2YXIgZG1PYmogPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhTW9kZWxPYmopO1xyXG4gICAgICAgIGRlbGV0ZSBkbU9ialsnX2lkJ107XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wYXRjaChtb2RlbE5hbWVVcmwsIGRtT2JqKS5waXBlKG1hcCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSksIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGdldCAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbElkfWApKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRocm93RXJyb3IobmV3IEVycm9yKGBDb3VsZCBub3QgZGVsZXRlICR7ZGF0YU1vZGVsTmFtZX0gYnkgaWQgJHtkYXRhTW9kZWxJZH0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvUXVlcnlTdHJpbmcob2JqKSB7XHJcbiAgICBjb25zdCBwYXJ0cyA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBpIGluIG9iaikge1xyXG4gICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGkpICYmIHRoaXMuY2hlY2tJZlZhbGlkKG9ialtpXSkpIHtcclxuICAgICAgICBwYXJ0cy5wdXNoKChpKSArICc9JyArIEpTT04uc3RyaW5naWZ5KG9ialtpXSkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFydHMuam9pbignJicpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjaGVja0lmVmFsaWQodmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSB7XHJcbiAgICBpZiAoIXRoaXMuZG1Ecykge1xyXG4gICAgICB0aGlzLmRtRHMgPSB3aW5kb3dbJ25ldXRyaW5vcyddWydkYXRhU291cmNlJ107XHJcbiAgICB9XHJcbiAgICBjb25zdCBkc0RtID0gdGhpcy5kbURzW2RhdGFNb2RlbE5hbWVdO1xyXG4gICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5wcm9wZXJ0aWVzO1xyXG4gICAgaWYgKGRzRG0pIHtcclxuICAgICAgcmV0dXJuIHByb3BlcnRpZXMuYmFzZVVybCArIHByb3BlcnRpZXMudGVuYW50TmFtZSArICcvZGF0YW1vZGVsLycgKyBkc0RtICsgJy8nICsgcHJvcGVydGllcy5hcHBOYW1lICsgJy8nO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc3lzdGVtU2VydmljZS5nZXREYXRhTW9kZWxVcmwoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxufVxyXG4iXX0=