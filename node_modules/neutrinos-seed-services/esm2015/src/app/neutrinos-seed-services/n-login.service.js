import { __decorate } from "tslib";
import { map } from 'rxjs/operators';
import { Injectable, EventEmitter, Output } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { NSystemService } from './n-system.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NNotificationService } from './n-notification.service';
let NLoginService = class NLoginService {
    constructor(http, pubSubService, notificationService, nLocalStorageService, nTokenService) {
        this.http = http;
        this.pubSubService = pubSubService;
        this.notificationService = notificationService;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.loginCompleted = new EventEmitter();
        this.systemService = NSystemService.getInstance();
        // this.nTokenService = new NTokenService();
        this.nSessionStorage = new NSessionStorageService();
        // this.nLocalStorageService = new NLocalStorageService();
    }
    login(userName, password, isRemember) {
        this.appProperties = this.systemService.getVal('properties');
        this.loginUrl = this.systemService.getAuthUrl() + this.appProperties.appName;
        this.uuid = this.nLocalStorageService.getValue('uuid');
        if (!this.uuid) {
            this.uuid = this.nLocalStorageService.checkDeviceId();
        }
        this.details = {
            username: userName,
            password: password,
        };
        this.details.platformDetails = this.systemService.getPlatformDetails(this.systemService.checkDevice());
        this.details.platformDetails['uuid'] = this.uuid;
        return this.http.post(this.loginUrl, JSON.stringify(this.details)).pipe(map(result => {
            const tokensObj = result;
            if (tokensObj) {
                this.nTokenService.updateTokens(tokensObj, isRemember);
            }
            // TODO chris array of supported pushes currently only support APNS and Firebase
            if ((this.systemService.getVal('firebaseSenderId') != 'FIREBASE_SENDER_ID' && this.systemService.getVal('firebaseAuthKey') != 'FIREBASE_AUTH_KEY')
                || (this.systemService.getVal('pushType') === 'APNS' && this.systemService.isIOS())) {
                this.pubSubService.$pub('firebaseRegister');
            }
            this.pubSubService.$pub('loginComplete');
            return (result);
        }, error => {
            return (error);
        }));
    }
    isLoggedIn() {
        return this.nLocalStorageService.initStorage().then(result => {
            if (this.nSessionStorage.getValue('accessToken') && this.nSessionStorage.getValue('refreshToken') &&
                this.nSessionStorage.getValue('accessToken') != 'null' && this.nSessionStorage.getValue('refreshToken') != 'null') {
                return true;
            }
            return false;
        }).catch(error => {
            return false;
        });
    }
};
NLoginService.ctorParameters = () => [
    { type: HttpClient },
    { type: NPubSubService },
    { type: NNotificationService },
    { type: NLocalStorageService },
    { type: NTokenService }
];
__decorate([
    Output()
], NLoginService.prototype, "loginCompleted", void 0);
NLoginService = __decorate([
    Injectable()
], NLoginService);
export { NLoginService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2dpbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL24tbG9naW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFNaEUsSUFBYSxhQUFhLEdBQTFCLE1BQWEsYUFBYTtJQVN4QixZQUFvQixJQUFnQixFQUFVLGFBQTZCLEVBQVUsbUJBQXlDLEVBQ3BILG9CQUEwQyxFQUFVLGFBQTRCO1FBRHRFLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZ0I7UUFBVSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO1FBQ3BILHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUZoRixtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFHNUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEQsNENBQTRDO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1FBQ3BELDBEQUEwRDtJQUM1RCxDQUFDO0lBR0QsS0FBSyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsVUFBVztRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQztRQUM3RSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN2RDtRQUNELElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixRQUFRLEVBQUUsUUFBUTtZQUNsQixRQUFRLEVBQUUsUUFBUTtTQUNuQixDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDdkcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNqRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ25GLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQztZQUN6QixJQUFJLFNBQVMsRUFBRTtnQkFDYixJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDeEQ7WUFDRCxnRkFBZ0Y7WUFDaEYsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLElBQUksb0JBQW9CLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsSUFBSSxtQkFBbUIsQ0FBQzttQkFDMUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxNQUFNLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFO2dCQUN4RixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2FBQzdDO1lBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDekMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xCLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRTtZQUNULE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVELFVBQVU7UUFDUixPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDM0QsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUM7Z0JBQy9GLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxJQUFJLE1BQU0sSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxNQUFNLEVBQUU7Z0JBQ25ILE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNmLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFFTCxDQUFDO0NBQ0YsQ0FBQTs7WUFuRDJCLFVBQVU7WUFBeUIsY0FBYztZQUErQixvQkFBb0I7WUFDOUYsb0JBQW9CO1lBQXlCLGFBQWE7O0FBRmhGO0lBQVQsTUFBTSxFQUFFO3FEQUFxQztBQVJuQyxhQUFhO0lBRHpCLFVBQVUsRUFBRTtHQUNBLGFBQWEsQ0E0RHpCO1NBNURZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHttYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE5TeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi9uLXN5c3RlbS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTlRva2VuU2VydmljZSB9IGZyb20gJy4vbi10b2tlbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTlB1YlN1YlNlcnZpY2UgfSBmcm9tICcuL24tcHViU3ViLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLXNlc3Npb25TdG9yYWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1sb2NhbFN0b3JhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IE5Ob3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9uLW5vdGlmaWNhdGlvbi5zZXJ2aWNlJztcclxuXHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOTG9naW5TZXJ2aWNlIHtcclxuICBsb2dpblVybDtcclxuICBhcHBQcm9wZXJ0aWVzO1xyXG4gIHN5c3RlbVNlcnZpY2U7XHJcbiAgblNlc3Npb25TdG9yYWdlO1xyXG4gIHV1aWQ7XHJcbiAgZGV0YWlsczogYW55O1xyXG5cclxuICBAT3V0cHV0KCkgbG9naW5Db21wbGV0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIHB1YlN1YlNlcnZpY2U6IE5QdWJTdWJTZXJ2aWNlLCBwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U6IE5Ob3RpZmljYXRpb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBuTG9jYWxTdG9yYWdlU2VydmljZTogTkxvY2FsU3RvcmFnZVNlcnZpY2UsIHByaXZhdGUgblRva2VuU2VydmljZTogTlRva2VuU2VydmljZSkge1xyXG4gICAgdGhpcy5zeXN0ZW1TZXJ2aWNlID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIC8vIHRoaXMublRva2VuU2VydmljZSA9IG5ldyBOVG9rZW5TZXJ2aWNlKCk7XHJcbiAgICB0aGlzLm5TZXNzaW9uU3RvcmFnZSA9IG5ldyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlKCk7XHJcbiAgICAvLyB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlID0gbmV3IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlKCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgbG9naW4odXNlck5hbWUsIHBhc3N3b3JkLCBpc1JlbWVtYmVyPykge1xyXG4gICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xyXG4gICAgdGhpcy5sb2dpblVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRBdXRoVXJsKCkgKyB0aGlzLmFwcFByb3BlcnRpZXMuYXBwTmFtZTtcclxuICAgIHRoaXMudXVpZCA9IHRoaXMubkxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0VmFsdWUoJ3V1aWQnKTtcclxuICAgIGlmICghdGhpcy51dWlkKSB7XHJcbiAgICAgIHRoaXMudXVpZCA9IHRoaXMubkxvY2FsU3RvcmFnZVNlcnZpY2UuY2hlY2tEZXZpY2VJZCgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5kZXRhaWxzID0ge1xyXG4gICAgICB1c2VybmFtZTogdXNlck5hbWUsXHJcbiAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCxcclxuICAgIH07XHJcbiAgICB0aGlzLmRldGFpbHMucGxhdGZvcm1EZXRhaWxzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFBsYXRmb3JtRGV0YWlscyh0aGlzLnN5c3RlbVNlcnZpY2UuY2hlY2tEZXZpY2UoKSk7XHJcbiAgICB0aGlzLmRldGFpbHMucGxhdGZvcm1EZXRhaWxzWyd1dWlkJ10gPSB0aGlzLnV1aWQ7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy5sb2dpblVybCwgSlNPTi5zdHJpbmdpZnkodGhpcy5kZXRhaWxzKSkucGlwZShtYXAocmVzdWx0ID0+IHtcclxuICAgICAgY29uc3QgdG9rZW5zT2JqID0gcmVzdWx0O1xyXG4gICAgICBpZiAodG9rZW5zT2JqKSB7XHJcbiAgICAgICAgdGhpcy5uVG9rZW5TZXJ2aWNlLnVwZGF0ZVRva2Vucyh0b2tlbnNPYmosIGlzUmVtZW1iZXIpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIFRPRE8gY2hyaXMgYXJyYXkgb2Ygc3VwcG9ydGVkIHB1c2hlcyBjdXJyZW50bHkgb25seSBzdXBwb3J0IEFQTlMgYW5kIEZpcmViYXNlXHJcbiAgICAgIGlmICgodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnZmlyZWJhc2VTZW5kZXJJZCcpICE9ICdGSVJFQkFTRV9TRU5ERVJfSUQnICYmIHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2ZpcmViYXNlQXV0aEtleScpICE9ICdGSVJFQkFTRV9BVVRIX0tFWScpIFxyXG4gICAgICAgICAgIHx8ICh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwdXNoVHlwZScpID09PSAnQVBOUycgJiYgdGhpcy5zeXN0ZW1TZXJ2aWNlLmlzSU9TKCkpKSB7XHJcbiAgICAgICAgdGhpcy5wdWJTdWJTZXJ2aWNlLiRwdWIoJ2ZpcmViYXNlUmVnaXN0ZXInKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnB1YlN1YlNlcnZpY2UuJHB1YignbG9naW5Db21wbGV0ZScpO1xyXG4gICAgICByZXR1cm4gKHJlc3VsdCk7XHJcbiAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgIHJldHVybiAoZXJyb3IpO1xyXG4gICAgfSkpO1xyXG4gIH1cclxuXHJcbiAgaXNMb2dnZWRJbigpIHtcclxuICAgIHJldHVybiB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmluaXRTdG9yYWdlKCkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICBpZiAodGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykgJiYgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3JlZnJlc2hUb2tlbicpICYmXHJcbiAgICAgICAgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykgIT0gJ251bGwnICYmIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdyZWZyZXNoVG9rZW4nKSAhPSAnbnVsbCcpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pO1xyXG5cclxuICB9XHJcbn1cclxuIl19