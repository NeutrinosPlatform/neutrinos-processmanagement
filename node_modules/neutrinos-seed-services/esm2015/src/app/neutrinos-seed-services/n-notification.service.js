import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { NLocalStorageService } from './n-localStorage.service';
import * as firebase from 'firebase';
import { NPubSubService } from './n-pubSub.service';
import { HttpClient } from '@angular/common/http';
import { NSessionStorageService } from './n-sessionStorage.service';
// import { Router } from '@angular/router';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
let NNotificationService = class NNotificationService {
    constructor(localStorageService, pubSubService, http, bHttpLoader) {
        this.localStorageService = localStorageService;
        this.pubSubService = pubSubService;
        this.http = http;
        this.bHttpLoader = bHttpLoader;
        // private static instance: NNotificationService;
        this.systemService = NSystemService.getInstance();
        this.possiblePushTypes = ['APNS', 'FCM'];
        this.firebaseSenderId = this.systemService.getVal('firebaseSenderId');
        this.isNotificationEnabled = this.systemService.getVal('isNotificationEnabled');
        this.appName = this.systemService.getVal('appName');
        this.deviceType = this.systemService.deviceType;
        this.sessionStorage = new NSessionStorageService();
        this.loginSubscribe = this.pubSubService.$sub('firebaseRegister', () => {
            this.enableNotification();
        });
    }
    ngOnInit() {
    }
    enableNotification() {
        let pushType = this.getPushType(this.systemService.getVal('pushType'));
        document.addEventListener('deviceready', event => {
            if (this.isNotificationEnabled) {
                if (this.deviceType && this.deviceType != 'browser') {
                    this.deviceType = this.systemService.deviceType;
                    this.checkPermission(pushType).then(res => {
                        if (res) {
                            this.initializeNotifications(pushType);
                        }
                    });
                }
            }
        });
        if (this.isNotificationEnabled && pushType !== 'APNS') {
            if (this.deviceType && this.deviceType == 'browser' && window['Notification']) {
                this.initialiseWebPush();
            }
        }
    }
    initialiseWebPush() {
        const __this = this;
        const messaging = firebase.messaging();
        Notification.requestPermission()
            .then(function () {
            return messaging.getToken();
        })
            .then(function (token) {
            if (token) {
                __this.sendRegDetails(token);
            }
        })
            .catch(function (err) {
            __this.bHttpLoader.alertError(err);
        });
        messaging.onMessage(function (payload) {
            if (payload['notification']) {
                let notificationObj = payload['notification'];
                let options = {
                    body: notificationObj.body,
                    icon: notificationObj.icon
                };
                // creating a native browser message
                let notificationUI = new Notification(notificationObj.title, options);
                notificationUI.onclick = function () {
                    window.focus(); // window is focused when the user clicks the notification using this
                };
            }
        });
    }
    checkPermission(pushType) {
        // Android & iOS only
        // Checks whether the push notification permission has been granted.
        return new Promise((resolve) => {
            pushType = this.getPushType(pushType);
            if ((this.deviceType === 'Android' || this.deviceType === 'iOS') && (pushType === 'FCM')) {
                PushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else if (this.deviceType === 'iOS' && pushType === 'APNS') {
                APNSPushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else {
                return resolve(true);
            }
        });
    }
    initializeNotifications(pushType) {
        //pushType = pushType ? pushType : 'FCM';
        pushType = this.getPushType(pushType);
        let push;
        // Default if for FCM
        if (pushType === 'FCM') {
            push = window['PushNotification'].init({
                android: {
                    senderID: this.firebaseSenderId
                },
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true",
                    senderID: this.firebaseSenderId
                },
            });
        }
        // New APNS plugin init
        else if (pushType === 'APNS') {
            push = window['APNSPushNotification'].init({
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true"
                }
            });
        }
        push.on('registration', (data) => {
            // data.registrationId
            this.sendRegDetails(data.registrationId);
        });
        // ToDo Christy get call back function from app user to change what happens once a notification arrives
        push.on('notification', (data) => {
            window['cordova'].plugins.notification.local.schedule({
                title: data.title,
                text: data.message,
                sound: data.sound,
                at: new Date().getTime()
            });
        });
        push.on('error', (e) => {
            // e.message
            console.error(e);
        });
    }
    sendRegDetails(registrationId) {
        this.localStorageService.setValue('registrationId', registrationId);
        var url = this.systemService.getTenantUrl() + 'notification/' + this.systemService.getVal('appName') + '/register';
        let pushType = this.getPushType(this.systemService.getVal('pushType'));
        this.http.post(url, {
            'key': this.sessionStorage.getValue('userObj')['userKey'],
            'uuid': this.localStorageService.getValue('uuid'),
            'fbregid': registrationId,
            'pushType': pushType
        }).subscribe(result => {
            // this.pubSubService.$pub('FBRegComp');
        }, error => {
            console.log(error);
        });
    }
    getPushType(currPushType) {
        let isValidPush = typeof currPushType !== 'undefined' && this.possiblePushTypes.includes(currPushType.toUpperCase());
        let pushType = isValidPush ? currPushType.toUpperCase() : 'FCM';
        return pushType;
    }
    ngOnDestroy() {
        this.loginSubscribe.unSubscribe();
    }
};
NNotificationService.ctorParameters = () => [
    { type: NLocalStorageService },
    { type: NPubSubService },
    { type: HttpClient },
    { type: NHTTPLoaderService }
];
NNotificationService = __decorate([
    Injectable()
], NNotificationService);
export { NNotificationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1ub3RpZmljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxLQUFLLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSw0Q0FBNEM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFLNUQsSUFBYSxvQkFBb0IsR0FBakMsTUFBYSxvQkFBb0I7SUFZL0IsWUFBb0IsbUJBQXlDLEVBQVUsYUFBNkIsRUFDMUYsSUFBZ0IsRUFBVSxXQUErQjtRQUQvQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQzFGLFNBQUksR0FBSixJQUFJLENBQVk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFabkUsaURBQWlEO1FBQ3pDLGtCQUFhLEdBQW1CLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQU03RCxzQkFBaUIsR0FBYSxDQUFDLE1BQU0sRUFBQyxLQUFLLENBQUMsQ0FBQztRQU1uRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7UUFDaEQsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLHNCQUFzQixFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7WUFDckUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsUUFBUTtJQUNSLENBQUM7SUFHRCxrQkFBa0I7UUFDaEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLEVBQUU7WUFDL0MsSUFBSSxJQUFJLENBQUMscUJBQXFCLEVBQUU7Z0JBQzlCLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLFNBQVMsRUFBRTtvQkFDbkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztvQkFDaEQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7d0JBQ3hDLElBQUksR0FBRyxFQUFFOzRCQUNQLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQzt5QkFDeEM7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7YUFDRjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxJQUFJLENBQUMscUJBQXFCLElBQUksUUFBUSxLQUFLLE1BQU0sRUFBRTtZQUNyRCxJQUFJLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxTQUFTLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUM3RSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQzthQUMxQjtTQUNGO0lBQ0gsQ0FBQztJQUVELGlCQUFpQjtRQUNmLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQztRQUNwQixNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFdkMsWUFBWSxDQUFDLGlCQUFpQixFQUFFO2FBQzdCLElBQUksQ0FBQztZQUNKLE9BQU8sU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlCLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxVQUFVLEtBQUs7WUFDbkIsSUFBSSxLQUFLLEVBQUU7Z0JBQ1QsTUFBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUM5QjtRQUNILENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxVQUFVLEdBQUc7WUFDbEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7UUFFTCxTQUFTLENBQUMsU0FBUyxDQUFDLFVBQVUsT0FBTztZQUNuQyxJQUFJLE9BQU8sQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFDM0IsSUFBSSxlQUFlLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUM5QyxJQUFJLE9BQU8sR0FBRztvQkFDWixJQUFJLEVBQUUsZUFBZSxDQUFDLElBQUk7b0JBQzFCLElBQUksRUFBRSxlQUFlLENBQUMsSUFBSTtpQkFDM0IsQ0FBQTtnQkFDRCxvQ0FBb0M7Z0JBQ3BDLElBQUksY0FBYyxHQUFHLElBQUksWUFBWSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3RFLGNBQWMsQ0FBQyxPQUFPLEdBQUc7b0JBQ3ZCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLHFFQUFxRTtnQkFDdkYsQ0FBQyxDQUFBO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxlQUFlLENBQUMsUUFBUztRQUN2QixxQkFBcUI7UUFDckIsb0VBQW9FO1FBQ3BFLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUM3QixRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxLQUFLLENBQUUsRUFBRTtnQkFDekYsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFVBQVUsSUFBSTtvQkFDM0MsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDLENBQUMsQ0FBQzthQUNKO2lCQUFNLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxLQUFLLElBQUksUUFBUSxLQUFLLE1BQU0sRUFBRTtnQkFDMUQsb0JBQW9CLENBQUMsYUFBYSxDQUFDLFVBQVUsSUFBSTtvQkFDaEQsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3RCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsdUJBQXVCLENBQUMsUUFBUztRQUMvQix5Q0FBeUM7UUFDekMsUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFdEMsSUFBSSxJQUFJLENBQUM7UUFDVCxxQkFBcUI7UUFDckIsSUFBSSxRQUFRLEtBQUssS0FBSyxFQUFFO1lBQ3RCLElBQUksR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ3JDLE9BQU8sRUFBRTtvQkFDUCxRQUFRLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtpQkFDaEM7Z0JBQ0QsR0FBRyxFQUFFO29CQUNILEtBQUssRUFBRSxNQUFNO29CQUNiLEtBQUssRUFBRSxNQUFNO29CQUNiLEtBQUssRUFBRSxNQUFNO29CQUNiLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCO2lCQUNoQzthQUNGLENBQUMsQ0FBQztTQUNKO1FBQ0QsdUJBQXVCO2FBQ2xCLElBQUksUUFBUSxLQUFLLE1BQU0sRUFBRTtZQUM1QixJQUFJLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUN6QyxHQUFHLEVBQUU7b0JBQ0gsS0FBSyxFQUFFLE1BQU07b0JBQ2IsS0FBSyxFQUFFLE1BQU07b0JBQ2IsS0FBSyxFQUFFLE1BQU07aUJBQ2Q7YUFDRixDQUFDLENBQUM7U0FDSjtRQUNELElBQUksQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDL0Isc0JBQXNCO1lBQ3RCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO1FBRUgsdUdBQXVHO1FBQ3ZHLElBQUksQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDL0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQztnQkFDcEQsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNqQixJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ2xCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsRUFBRSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFO2FBQ3pCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNyQixZQUFZO1lBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxjQUFjLENBQUMsY0FBYztRQUMzQixJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3BFLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLEdBQUcsZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNuSCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2xCLEtBQUssRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFDekQsTUFBTSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ2pELFNBQVMsRUFBRSxjQUFjO1lBQ3pCLFVBQVUsRUFBRSxRQUFRO1NBQ3JCLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDcEIsd0NBQXdDO1FBQzFDLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsV0FBVyxDQUFFLFlBQVk7UUFDdkIsSUFBSSxXQUFXLEdBQUcsT0FBTyxZQUFZLEtBQUssV0FBVyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDckgsSUFBSSxRQUFRLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNoRSxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEMsQ0FBQztDQUNGLENBQUE7O1lBcEswQyxvQkFBb0I7WUFBeUIsY0FBYztZQUNwRixVQUFVO1lBQXVCLGtCQUFrQjs7QUFieEQsb0JBQW9CO0lBRGhDLFVBQVUsRUFBRTtHQUNBLG9CQUFvQixDQWdMaEM7U0FoTFksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25Jbml0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmRlY2xhcmUgdmFyIFB1c2hOb3RpZmljYXRpb246IGFueTtcclxuZGVjbGFyZSB2YXIgQVBOU1B1c2hOb3RpZmljYXRpb246IGFueTtcclxuaW1wb3J0IHsgTkxvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tbG9jYWxTdG9yYWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgKiBhcyBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZSc7XHJcbmltcG9ydCB7IE5QdWJTdWJTZXJ2aWNlIH0gZnJvbSAnLi9uLXB1YlN1Yi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcclxuLy8gaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgTkhUVFBMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9uLUhUVFBMb2FkZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IGVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnByb2QnO1xyXG5cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE5Ob3RpZmljYXRpb25TZXJ2aWNlIHtcclxuICAvLyBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogTk5vdGlmaWNhdGlvblNlcnZpY2U7XHJcbiAgcHJpdmF0ZSBzeXN0ZW1TZXJ2aWNlOiBOU3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbiAgcHJpdmF0ZSBmaXJlYmFzZVNlbmRlcklkOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBpc05vdGlmaWNhdGlvbkVuYWJsZWQ6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBkZXZpY2VUeXBlOyBzdHJpbmc7XHJcbiAgcHJpdmF0ZSByZXNEZXRhaWxzO1xyXG4gIHByaXZhdGUgZGV2aWNlVVVJRDogc3RyaW5nO1xyXG4gIHByaXZhdGUgcG9zc2libGVQdXNoVHlwZXM6IHN0cmluZ1tdID0gWydBUE5TJywnRkNNJ107XHJcbiAgbG9naW5TdWJzY3JpYmU7XHJcbiAgc2Vzc2lvblN0b3JhZ2U6IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2U7XHJcbiAgYXBwTmFtZTtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2FsU3RvcmFnZVNlcnZpY2U6IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLCBwcml2YXRlIHB1YlN1YlNlcnZpY2U6IE5QdWJTdWJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGJIdHRwTG9hZGVyOiBOSFRUUExvYWRlclNlcnZpY2UpIHtcclxuICAgIHRoaXMuZmlyZWJhc2VTZW5kZXJJZCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2ZpcmViYXNlU2VuZGVySWQnKTtcclxuICAgIHRoaXMuaXNOb3RpZmljYXRpb25FbmFibGVkID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnaXNOb3RpZmljYXRpb25FbmFibGVkJyk7XHJcbiAgICB0aGlzLmFwcE5hbWUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdhcHBOYW1lJyk7XHJcbiAgICB0aGlzLmRldmljZVR5cGUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZGV2aWNlVHlwZTtcclxuICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xyXG4gICAgdGhpcy5sb2dpblN1YnNjcmliZSA9IHRoaXMucHViU3ViU2VydmljZS4kc3ViKCdmaXJlYmFzZVJlZ2lzdGVyJywgKCkgPT4ge1xyXG4gICAgICB0aGlzLmVuYWJsZU5vdGlmaWNhdGlvbigpO1xyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gIH1cclxuXHJcblxyXG4gIGVuYWJsZU5vdGlmaWNhdGlvbigpIHtcclxuICAgIGxldCBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSk7XHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VyZWFkeScsIGV2ZW50ID0+IHtcclxuICAgICAgaWYgKHRoaXMuaXNOb3RpZmljYXRpb25FbmFibGVkKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlVHlwZSAmJiB0aGlzLmRldmljZVR5cGUgIT0gJ2Jyb3dzZXInKSB7XHJcbiAgICAgICAgICB0aGlzLmRldmljZVR5cGUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZGV2aWNlVHlwZTtcclxuICAgICAgICAgIHRoaXMuY2hlY2tQZXJtaXNzaW9uKHB1c2hUeXBlKS50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXMpIHtcclxuICAgICAgICAgICAgICB0aGlzLmluaXRpYWxpemVOb3RpZmljYXRpb25zKHB1c2hUeXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGlmICh0aGlzLmlzTm90aWZpY2F0aW9uRW5hYmxlZCAmJiBwdXNoVHlwZSAhPT0gJ0FQTlMnKSB7XHJcbiAgICAgIGlmICh0aGlzLmRldmljZVR5cGUgJiYgdGhpcy5kZXZpY2VUeXBlID09ICdicm93c2VyJyAmJiB3aW5kb3dbJ05vdGlmaWNhdGlvbiddKSB7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXNlV2ViUHVzaCgpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXNlV2ViUHVzaCgpIHtcclxuICAgIGNvbnN0IF9fdGhpcyA9IHRoaXM7XHJcbiAgICBjb25zdCBtZXNzYWdpbmcgPSBmaXJlYmFzZS5tZXNzYWdpbmcoKTtcclxuXHJcbiAgICBOb3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKVxyXG4gICAgICAudGhlbihmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2luZy5nZXRUb2tlbigpO1xyXG4gICAgICB9KVxyXG4gICAgICAudGhlbihmdW5jdGlvbiAodG9rZW4pIHtcclxuICAgICAgICBpZiAodG9rZW4pIHtcclxuICAgICAgICAgIF9fdGhpcy5zZW5kUmVnRGV0YWlscyh0b2tlbik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIF9fdGhpcy5iSHR0cExvYWRlci5hbGVydEVycm9yKGVycik7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIG1lc3NhZ2luZy5vbk1lc3NhZ2UoZnVuY3Rpb24gKHBheWxvYWQpIHtcclxuICAgICAgaWYgKHBheWxvYWRbJ25vdGlmaWNhdGlvbiddKSB7XHJcbiAgICAgICAgbGV0IG5vdGlmaWNhdGlvbk9iaiA9IHBheWxvYWRbJ25vdGlmaWNhdGlvbiddO1xyXG4gICAgICAgIGxldCBvcHRpb25zID0ge1xyXG4gICAgICAgICAgYm9keTogbm90aWZpY2F0aW9uT2JqLmJvZHksXHJcbiAgICAgICAgICBpY29uOiBub3RpZmljYXRpb25PYmouaWNvblxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjcmVhdGluZyBhIG5hdGl2ZSBicm93c2VyIG1lc3NhZ2VcclxuICAgICAgICBsZXQgbm90aWZpY2F0aW9uVUkgPSBuZXcgTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbk9iai50aXRsZSwgb3B0aW9ucyk7XHJcbiAgICAgICAgbm90aWZpY2F0aW9uVUkub25jbGljayA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIHdpbmRvdy5mb2N1cygpOyAvLyB3aW5kb3cgaXMgZm9jdXNlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgbm90aWZpY2F0aW9uIHVzaW5nIHRoaXNcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY2hlY2tQZXJtaXNzaW9uKHB1c2hUeXBlPykge1xyXG4gICAgLy8gQW5kcm9pZCAmIGlPUyBvbmx5XHJcbiAgICAvLyBDaGVja3Mgd2hldGhlciB0aGUgcHVzaCBub3RpZmljYXRpb24gcGVybWlzc2lvbiBoYXMgYmVlbiBncmFudGVkLlxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZShwdXNoVHlwZSk7XHJcbiAgICAgIGlmICgodGhpcy5kZXZpY2VUeXBlID09PSAnQW5kcm9pZCcgfHwgdGhpcy5kZXZpY2VUeXBlID09PSAnaU9TJykgJiYgKHB1c2hUeXBlID09PSAnRkNNJyApKSB7XHJcbiAgICAgICAgUHVzaE5vdGlmaWNhdGlvbi5oYXNQZXJtaXNzaW9uKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhLmlzRW5hYmxlZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5kZXZpY2VUeXBlID09PSAnaU9TJyAmJiBwdXNoVHlwZSA9PT0gJ0FQTlMnKSB7XHJcbiAgICAgICAgIEFQTlNQdXNoTm90aWZpY2F0aW9uLmhhc1Blcm1pc3Npb24oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEuaXNFbmFibGVkKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplTm90aWZpY2F0aW9ucyhwdXNoVHlwZT8pIHtcclxuICAgIC8vcHVzaFR5cGUgPSBwdXNoVHlwZSA/IHB1c2hUeXBlIDogJ0ZDTSc7XHJcbiAgICBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUocHVzaFR5cGUpO1xyXG5cclxuICAgIGxldCBwdXNoO1xyXG4gICAgLy8gRGVmYXVsdCBpZiBmb3IgRkNNXHJcbiAgICBpZiAocHVzaFR5cGUgPT09ICdGQ00nKSB7XHJcbiAgICAgIHB1c2ggPSB3aW5kb3dbJ1B1c2hOb3RpZmljYXRpb24nXS5pbml0KHtcclxuICAgICAgICBhbmRyb2lkOiB7XHJcbiAgICAgICAgICBzZW5kZXJJRDogdGhpcy5maXJlYmFzZVNlbmRlcklkXHJcbiAgICAgICAgfSxcclxuICAgICAgICBpb3M6IHtcclxuICAgICAgICAgIGFsZXJ0OiBcInRydWVcIixcclxuICAgICAgICAgIGJhZGdlOiBcInRydWVcIixcclxuICAgICAgICAgIHNvdW5kOiBcInRydWVcIixcclxuICAgICAgICAgIHNlbmRlcklEOiB0aGlzLmZpcmViYXNlU2VuZGVySWRcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIE5ldyBBUE5TIHBsdWdpbiBpbml0XHJcbiAgICBlbHNlIGlmIChwdXNoVHlwZSA9PT0gJ0FQTlMnKSB7XHJcbiAgICAgIHB1c2ggPSB3aW5kb3dbJ0FQTlNQdXNoTm90aWZpY2F0aW9uJ10uaW5pdCh7XHJcbiAgICAgICAgaW9zOiB7XHJcbiAgICAgICAgICBhbGVydDogXCJ0cnVlXCIsXHJcbiAgICAgICAgICBiYWRnZTogXCJ0cnVlXCIsXHJcbiAgICAgICAgICBzb3VuZDogXCJ0cnVlXCJcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcHVzaC5vbigncmVnaXN0cmF0aW9uJywgKGRhdGEpID0+IHtcclxuICAgICAgLy8gZGF0YS5yZWdpc3RyYXRpb25JZFxyXG4gICAgICB0aGlzLnNlbmRSZWdEZXRhaWxzKGRhdGEucmVnaXN0cmF0aW9uSWQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVG9EbyBDaHJpc3R5IGdldCBjYWxsIGJhY2sgZnVuY3Rpb24gZnJvbSBhcHAgdXNlciB0byBjaGFuZ2Ugd2hhdCBoYXBwZW5zIG9uY2UgYSBub3RpZmljYXRpb24gYXJyaXZlc1xyXG4gICAgcHVzaC5vbignbm90aWZpY2F0aW9uJywgKGRhdGEpID0+IHtcclxuICAgICAgd2luZG93Wydjb3Jkb3ZhJ10ucGx1Z2lucy5ub3RpZmljYXRpb24ubG9jYWwuc2NoZWR1bGUoe1xyXG4gICAgICAgIHRpdGxlOiBkYXRhLnRpdGxlLFxyXG4gICAgICAgIHRleHQ6IGRhdGEubWVzc2FnZSxcclxuICAgICAgICBzb3VuZDogZGF0YS5zb3VuZCxcclxuICAgICAgICBhdDogbmV3IERhdGUoKS5nZXRUaW1lKClcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBwdXNoLm9uKCdlcnJvcicsIChlKSA9PiB7XHJcbiAgICAgIC8vIGUubWVzc2FnZVxyXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzZW5kUmVnRGV0YWlscyhyZWdpc3RyYXRpb25JZCkge1xyXG4gICAgdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnNldFZhbHVlKCdyZWdpc3RyYXRpb25JZCcsIHJlZ2lzdHJhdGlvbklkKTtcclxuICAgIHZhciB1cmwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VGVuYW50VXJsKCkgKyAnbm90aWZpY2F0aW9uLycgKyB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdhcHBOYW1lJykgKyAnL3JlZ2lzdGVyJztcclxuICAgIGxldCBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSk7XHJcbiAgICB0aGlzLmh0dHAucG9zdCh1cmwsIHtcclxuICAgICAgJ2tleSc6IHRoaXMuc2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3VzZXJPYmonKVsndXNlcktleSddLFxyXG4gICAgICAndXVpZCc6IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXRWYWx1ZSgndXVpZCcpLCBcclxuICAgICAgJ2ZicmVnaWQnOiByZWdpc3RyYXRpb25JZCxcclxuICAgICAgJ3B1c2hUeXBlJzogcHVzaFR5cGVcclxuICAgIH0pLnN1YnNjcmliZShyZXN1bHQgPT4ge1xyXG4gICAgICAvLyB0aGlzLnB1YlN1YlNlcnZpY2UuJHB1YignRkJSZWdDb21wJyk7XHJcbiAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBnZXRQdXNoVHlwZSAoY3VyclB1c2hUeXBlKSB7XHJcbiAgICBsZXQgaXNWYWxpZFB1c2ggPSB0eXBlb2YgY3VyclB1c2hUeXBlICE9PSAndW5kZWZpbmVkJyAmJiB0aGlzLnBvc3NpYmxlUHVzaFR5cGVzLmluY2x1ZGVzKGN1cnJQdXNoVHlwZS50b1VwcGVyQ2FzZSgpKTtcclxuICAgIGxldCBwdXNoVHlwZSA9IGlzVmFsaWRQdXNoID8gY3VyclB1c2hUeXBlLnRvVXBwZXJDYXNlKCkgOiAnRkNNJztcclxuICAgIHJldHVybiBwdXNoVHlwZTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5sb2dpblN1YnNjcmliZS51blN1YnNjcmliZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=