import { __decorate } from "tslib";
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig, Driver } from 'ngforage';
import { NUtility } from './n-util.service';
let NLocalStorageService = class NLocalStorageService {
    constructor(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    initStorage() {
        return new Promise((resolve, reject) => {
            if (window['cordova']) {
                this.initNgForage();
            }
            this.ngf.iterate((value, key, iteratonNumber) => {
                this.storageCache[key] = value;
            }).then(result => {
                this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(error => {
                return reject(error);
            });
        });
    }
    getStorage() {
        return this.storageCache;
    }
    setValue(key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(result => {
            return result;
        }, error => {
            console.log(error);
        });
    }
    getValue(key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            const obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (error) {
            return this.storageCache[key];
        }
    }
    remove(key) {
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(fulfilled => {
            delete this.ngf[key];
        }).catch(error => {
            console.error('Could not remove', key);
        });
    }
    clear() {
        this.storageCache = {};
        this.ngf.clear();
    }
    pluginCheck() {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    }
    getItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.getItem(key, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    setItemNs(key, value) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.setItem(key, value, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    removeItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.remove(key, (result) => {
                    resolve(result);
                }, (error) => {
                    reject(error);
                });
            }
        });
    }
    clearNs() {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.clear(result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    initNgForage() {
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                Driver.WEB_SQL,
            ]
        });
    }
    promiseReflect(promise) {
        return promise.then(resolved => { return { v: resolved, status: 'resolved' }; }, error => { return { e: error, status: 'rejected' }; });
    }
    clearLocalStorage() {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    }
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
    */
    checkDeviceId() {
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get((uuid) => {
                this._deviceUUID = uuid;
                this.setValue('uuid', this._deviceUUID);
            });
        }
        return this._deviceUUID;
    }
    get deviceUUID() {
        return this._deviceUUID;
    }
};
NLocalStorageService.ctorParameters = () => [
    { type: NgForageConfig },
    { type: NgForage },
    { type: NgForageCache }
];
NLocalStorageService = __decorate([
    Injectable()
], NLocalStorageService);
export { NLocalStorageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUc1QyxJQUFhLG9CQUFvQixHQUFqQyxNQUFhLG9CQUFvQjtJQUsvQixZQUFvQixTQUEwQixFQUFtQixHQUFjLEVBQW1CLFFBQXdCO1FBQXRHLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQW1CLFFBQUcsR0FBSCxHQUFHLENBQVc7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBZ0I7UUFIMUgsaUJBQVksR0FBUSxFQUFFLENBQUM7SUFJdkIsQ0FBQztJQUlELFdBQVc7UUFDVCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUNyQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDckI7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDZixJ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RSxLQUFLLFNBQVMsRUFBRTtZQUM1RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFekMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Y7YUFBTTtZQUNMLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0NBQ0YsQ0FBQTs7WUF2S2lDLGNBQWM7WUFBeUIsUUFBUTtZQUE4QixhQUFhOztBQUwvRyxvQkFBb0I7SUFEaEMsVUFBVSxFQUFFO0dBQ0Esb0JBQW9CLENBNEtoQztTQTVLWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtOZ0ZvcmFnZSwgTmdGb3JhZ2VDYWNoZSwgTmdGb3JhZ2VDb25maWcsIERyaXZlcn0gZnJvbSAnbmdmb3JhZ2UnO1xyXG5pbXBvcnQgeyBOVXRpbGl0eSB9IGZyb20gJy4vbi11dGlsLnNlcnZpY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTkxvY2FsU3RvcmFnZVNlcnZpY2Uge1xyXG5cclxuICBzdG9yYWdlQ2FjaGU6IGFueSA9IHt9O1xyXG4gIHByaXZhdGUgX2RldmljZVVVSUQ7XHJcbiAgcHJpdmF0ZSBuYXRpdmVTdG9yYWdlSTtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nZkNvbmZpZz86IE5nRm9yYWdlQ29uZmlnLCBwcml2YXRlIHJlYWRvbmx5IG5nZj86IE5nRm9yYWdlLCBwcml2YXRlIHJlYWRvbmx5IG5nZkNhY2hlPzogTmdGb3JhZ2VDYWNoZSkge1xyXG4gIH1cclxuXHJcblxyXG5cclxuICBpbml0U3RvcmFnZSgpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xyXG4gICAgICAgIHRoaXMuaW5pdE5nRm9yYWdlKCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5uZ2YuaXRlcmF0ZSgodmFsdWUsIGtleSwgaXRlcmF0b25OdW1iZXIpID0+IHtcclxuICAgICAgICB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldID0gdmFsdWU7XHJcbiAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICB0aGlzLmNoZWNrRGV2aWNlSWQoKTtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZSgnaXRlcmF0aW9uIGlzIGNvbXBsZXRlZCcpXHJcbiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldFN0b3JhZ2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlQ2FjaGU7XHJcbiAgfVxyXG5cclxuXHJcbiAgc2V0VmFsdWUoa2V5LCB2YWx1ZSkge1xyXG4gICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XHJcbiAgICAgIHRoaXMuaW5pdE5nRm9yYWdlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldID0gdmFsdWU7XHJcbiAgICByZXR1cm4gdGhpcy5uZ2Yuc2V0SXRlbShrZXksIHZhbHVlKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0VmFsdWUoa2V5KTogYW55IHwgUHJvbWlzZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH0gdHJ5IHtcclxuICAgICAgY29uc3Qgb2JqID0gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XVxyXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShvYmopO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZUNhY2hlW2tleV07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW1vdmUoa2V5KSB7XHJcbiAgICBkZWxldGUgdGhpcy5zdG9yYWdlQ2FjaGVba2V5XTtcclxuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xyXG4gICAgICB0aGlzLmluaXROZ0ZvcmFnZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5uZ2YucmVtb3ZlSXRlbShrZXkpLnRoZW4oZnVsZmlsbGVkID0+IHtcclxuICAgICAgZGVsZXRlIHRoaXMubmdmW2tleV07XHJcbiAgICB9KS5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkIG5vdCByZW1vdmUnLCBrZXkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBjbGVhcigpIHtcclxuICAgIHRoaXMuc3RvcmFnZUNhY2hlID0ge307XHJcbiAgICB0aGlzLm5nZi5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwbHVnaW5DaGVjaygpIHtcclxuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xyXG4gICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJID0gd2luZG93WydOYXRpdmVTdG9yYWdlJ107XHJcbiAgICAgIC8vIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgLy8gdGhpcy5pbml0U3RvcmFnZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRJdGVtTnMoa2V5KSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcclxuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLmdldEl0ZW0oa2V5LCByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0SXRlbU5zKGtleSwgdmFsdWUpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xyXG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuc2V0SXRlbShrZXksIHZhbHVlLCByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlSXRlbU5zKGtleSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XHJcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5yZW1vdmUoa2V5LCAocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGVhck5zKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XHJcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5jbGVhcihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdE5nRm9yYWdlKCkge1xyXG4gICAgdGhpcy5uZ2ZDb25maWcuY29uZmlndXJlKHtcclxuICAgICAgbmFtZTogJ015QXBwJyxcclxuICAgICAgZHJpdmVyOiBbXHJcbiAgICAgICAgRHJpdmVyLldFQl9TUUwsXHJcbiAgICAgIF1cclxuICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJvbWlzZVJlZmxlY3QocHJvbWlzZSkge1xyXG4gICAgcmV0dXJuIHByb21pc2UudGhlbihyZXNvbHZlZCA9PiB7IHJldHVybiB7IHY6IHJlc29sdmVkLCBzdGF0dXM6ICdyZXNvbHZlZCcgfSB9LCBlcnJvciA9PiB7IHJldHVybiB7IGU6IGVycm9yLCBzdGF0dXM6ICdyZWplY3RlZCcgfSB9KVxyXG4gIH1cclxuXHJcbiAgY2xlYXJMb2NhbFN0b3JhZ2UoKSB7XHJcbiAgICB0aGlzLnJlbW92ZSgndXNlck9iaicpO1xyXG4gICAgdGhpcy5yZW1vdmUoJ2FjY2Vzc1Rva2VuJyk7XHJcbiAgICB0aGlzLnJlbW92ZSgncmVmcmVzaFRva2VuJyk7XHJcbiAgICB0aGlzLnJlbW92ZSgncmVnaXN0cmF0aW9uSWQnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIER1ZSB0byB0aW1pbmcgaXNzdWVzIGFuZCBjaXJjdWxhciBkZXBlbmRlbmN5IGNoZWNrRGV2aWNlSWQgaXMgbW92ZWQgZnJvbSBOU3lzdGVtU2VydmljZVxyXG4gICovXHJcblxyXG4gIGNoZWNrRGV2aWNlSWQoKSB7XHJcbiAgICBpZiAoTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5jaGVja0RldmljZSgpID09PSAnYnJvd3NlcicpIHtcclxuICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHRoaXMuZ2V0VmFsdWUoJ3V1aWQnKTtcclxuXHJcbiAgICAgIGlmICghdGhpcy5fZGV2aWNlVVVJRCkge1xyXG4gICAgICAgIHRoaXMuX2RldmljZVVVSUQgPSBuZXcgTlV0aWxpdHkoKS5nZW5lcmF0ZVVVSUQoKTtcclxuICAgICAgICB0aGlzLnNldFZhbHVlKCd1dWlkJywgdGhpcy5fZGV2aWNlVVVJRCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHdpbmRvd1sncGx1Z2lucyddLnVuaXF1ZURldmljZUlELmdldCgodXVpZCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2RldmljZVVVSUQgPSB1dWlkO1xyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUoJ3V1aWQnLCB0aGlzLl9kZXZpY2VVVUlEKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlVVVJRDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgZGV2aWNlVVVJRCgpIHtcclxuICAgIHJldHVybiB0aGlzLl9kZXZpY2VVVUlEO1xyXG4gIH1cclxufVxyXG4iXX0=