import { __decorate } from "tslib";
import { Injectable, Injector } from '@angular/core';
import { HttpHeaders, HttpErrorResponse, HttpClient } from '@angular/common/http';
import { BehaviorSubject, throwError } from 'rxjs';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
import { NSystemService } from './n-system.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { timeout, catchError, finalize, switchMap, filter, take } from 'rxjs/operators';
var NHttpService = /** @class */ (function () {
    function NHttpService(nHTTPLoader, inj, nLocalStorageService, nTokenService) {
        this.nHTTPLoader = nHTTPLoader;
        this.inj = inj;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.timeout = 90000;
        this.isRefreshingToken = false;
        this.tokenSubject = new BehaviorSubject(null);
        this.systemService = NSystemService.getInstance();
        this.nSessionStorage = new NSessionStorageService();
        this.appProperties = this.systemService.getVal('properties');
        this.nPubSubService = new NPubSubService();
    }
    NHttpService.prototype.intercept = function (req, next) {
        var _this = this;
        this.requestInterceptor();
        // Pass on the cloned request instead of the original request.
        return next.handle(this.requestOptions(req))
            .pipe(timeout(this.timeout), catchError(function (error) { return _this.onCatch(error, req, next); }), finalize(function () {
            _this.onFinally();
        }));
    };
    NHttpService.prototype.updateToken = function (error, req, next) {
        var _this = this;
        if (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
            this.appProperties.appAuthenticationStrategy === 'localAuth') {
            if (!this.isRefreshingToken) {
                this.isRefreshingToken = true;
                // Reset here so that the following requests wait until the token
                // comes back from the refreshToken call.
                this.tokenSubject.next(null);
                return this.refreshToken()
                    .pipe(switchMap(function (tokensObj) {
                    if (tokensObj) {
                        _this.nTokenService.updateTokens(tokensObj);
                        var newToken = tokensObj['accessToken'];
                        _this.tokenSubject.next(newToken);
                        return next.handle(_this.requestOptions(req));
                    }
                    return throwError(new Error('Can\'t refresh the token'));
                }), catchError(function (err) { return _this.onCatchError(err); }), finalize(function () { return _this.isRefreshingToken = false; }));
            }
            else {
                return this.tokenSubject.pipe(filter(function (token) { return token != null; }), take(1), switchMap(function (token) { return next.handle(_this.requestOptions(req)); }));
            }
        }
        else {
            return this.onCatchError(error);
        }
    };
    NHttpService.prototype.refreshToken = function () {
        var http = this.inj.get(HttpClient);
        var appProperties = this.systemService.getVal('properties');
        var refreshUrl = this.systemService.getAuthUrl() + appProperties.appName + '/refresh';
        var body = {
            'platformDetails': this.systemService.getPlatformDetails(this.systemService.checkDevice()),
            'userKey': this.nSessionStorage.getValue('userObj')['userKey'],
            'refreshToken': this.nSessionStorage.getValue('refreshToken')
        };
        body.platformDetails['uuid'] = this.nLocalStorageService.getValue('uuid');
        return http.post(refreshUrl, body);
    };
    /**
     * Request options.
     * @param options
     * @returns HttpRequest
     */
    NHttpService.prototype.requestOptions = function (req) {
        var headers = req.headers;
        if (req.headers == null) {
            headers = new HttpHeaders();
        }
        req = req.clone({
            url: this.getFullUrl(req.url),
            headers: headers
        });
        var baseUrl = NSystemService.getInstance().getVal('baseUrl');
        var isArt = (baseUrl !== '' && req.url.includes(baseUrl));
        return isArt ? this.addDefaultHeaders(req) : req;
    };
    /**
    * Default options.
    * @param options
    * @returns HttpHeadedrs
    */
    NHttpService.prototype.addDefaultHeaders = function (req) {
        /**
         * TODO: Add all default Headers over here
         */
        if (!req.headers.has('Access-Control-Allow-Origin')) {
            req.headers = req.headers.set('Access-Control-Allow-Origin', '*');
        }
        if (!req.headers.has('Content-Type')) {
            req.headers = req.headers.set('Content-Type', 'application/json');
        }
        else if (req.headers.has('Content-Type') && (req.headers.get('Content-Type') === 'no-content')) {
            req.headers = req.headers.delete('Content-Type');
        }
        if (!req.headers.has('Accept')) {
            req.headers = req.headers.set('Accept', 'application/json');
        }
        if (!req.headers.has('Authorization')) {
            this.appProperties = this.systemService.getVal('properties');
            if (this.appProperties && this.appProperties.appAuthenticationStrategy === 'basicAuth') {
                var username = void 0, password = void 0;
                if (this.appProperties.basicAuthUser && this.appProperties.basicAuthPassword) {
                    username = this.appProperties.basicAuthUser;
                    password = this.appProperties.basicAuthPassword;
                }
                else {
                    username = "bhive-art-proxyuser";
                    password = "password";
                    console.warn("Authentication strategy: Basic Auth. basicAuthUser and basicAuthPassword are not configured in environment. Setting default values.");
                }
                req.headers = req.headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
            }
            else if (this.appProperties && (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
                this.appProperties.appAuthenticationStrategy === 'localAuth')) {
                if (this.nSessionStorage.getValue('accessToken')) {
                    req.headers = req.headers.set('Authorization', 'Bearer ' + this.nSessionStorage.getValue('accessToken'));
                }
            }
        }
        return req;
    };
    /**
     * Build API url.
     * @param url
     * @returns string
     */
    NHttpService.prototype.getFullUrl = function (url) {
        // return full URL to API here
        return url;
    };
    /**
     * Request interceptor.
     */
    NHttpService.prototype.requestInterceptor = function () {
        this.nHTTPLoader.isHTTPRequestInProgress(true);
    };
    /**
     * Response interceptor.
     */
    NHttpService.prototype.responseInterceptor = function () {
        this.nHTTPLoader.isHTTPRequestInProgress(false);
    };
    /**
      * Error handler.
      * @param error
      * @param caught
      * @returns ErrorObservable
      */
    NHttpService.prototype.onCatch = function (error, req, next) {
        if (error instanceof HttpErrorResponse) {
            if (error.status === 403 && error.error.message === 'jwt expired') {
                return this.updateToken(error, req, next);
            }
            else {
                return this.onSubscribeError(error);
            }
        }
        else {
            return this.onSubscribeError(error);
        }
    };
    /**
     * onSubscribeError
     * @param error
     */
    NHttpService.prototype.onSubscribeError = function (err) {
        this.nHTTPLoader.alertError(err);
        return this.onCatchError(err);
    };
    /**
     * onFinally
     */
    NHttpService.prototype.onFinally = function () {
        this.responseInterceptor();
    };
    NHttpService.prototype.onCatchError = function (error) {
        return throwError(error);
    };
    NHttpService.ctorParameters = function () { return [
        { type: NHTTPLoaderService },
        { type: Injector },
        { type: NLocalStorageService },
        { type: NTokenService }
    ]; };
    NHttpService = __decorate([
        Injectable()
    ], NHttpService);
    return NHttpService;
}());
export { NHttpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1IVFRQLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvbi1IVFRQLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFLTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDWCxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBYyxlQUFlLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3hGO0lBU0Usc0JBQW9CLFdBQStCLEVBQVUsR0FBYSxFQUNoRSxvQkFBMEMsRUFBVSxhQUE0QjtRQUR0RSxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFVO1FBQ2hFLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQVQxRixZQUFPLEdBQUcsS0FBSyxDQUFDO1FBSWhCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUUxQixpQkFBWSxHQUE0QixJQUFJLGVBQWUsQ0FBUyxJQUFJLENBQUMsQ0FBQztRQUl4RSxJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksc0JBQXNCLEVBQUUsQ0FBQztRQUNwRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZ0NBQVMsR0FBVCxVQUFVLEdBQXFCLEVBQUUsSUFBaUI7UUFBbEQsaUJBVUM7UUFUQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUUxQiw4REFBOEQ7UUFDOUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQ3ZCLFVBQVUsQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBOUIsQ0FBOEIsQ0FBQyxFQUNuRCxRQUFRLENBQUM7WUFDVCxLQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNWLENBQUM7SUFFRCxrQ0FBVyxHQUFYLFVBQVksS0FBd0IsRUFBRSxHQUFxQixFQUFFLElBQWlCO1FBQTlFLGlCQWtDQztRQWpDQyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMseUJBQXlCLEtBQUssaUJBQWlCO1lBQ3BFLElBQUksQ0FBQyxhQUFhLENBQUMseUJBQXlCLEtBQUssV0FBVyxFQUFFO1lBQzlELElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7Z0JBRTlCLGlFQUFpRTtnQkFDakUseUNBQXlDO2dCQUN6QyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFN0IsT0FBTyxJQUFJLENBQUMsWUFBWSxFQUFFO3FCQUN2QixJQUFJLENBQ0gsU0FBUyxDQUFDLFVBQUMsU0FBaUI7b0JBQzFCLElBQUksU0FBUyxFQUFFO3dCQUNiLEtBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO3dCQUMzQyxJQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7d0JBQzFDLEtBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUNqQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3FCQUM5QztvQkFDRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7Z0JBQzNELENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEtBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQXRCLENBQXNCLENBQUMsRUFDekMsUUFBUSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxFQUE5QixDQUE4QixDQUFDLENBQy9DLENBQUM7YUFDTDtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUMzQixNQUFNLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFLLElBQUksSUFBSSxFQUFiLENBQWEsQ0FBQyxFQUM5QixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQ1AsU0FBUyxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQXJDLENBQXFDLENBQUMsQ0FDMUQsQ0FBQzthQUNIO1NBQ0Y7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNqQztJQUNILENBQUM7SUFFRCxtQ0FBWSxHQUFaO1FBQ0UsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEMsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDOUQsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxhQUFhLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQztRQUN4RixJQUFNLElBQUksR0FBRztZQUNYLGlCQUFpQixFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMxRixTQUFTLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzlELGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUM7U0FDOUQsQ0FBQztRQUNGLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFHRDs7OztPQUlHO0lBQ0sscUNBQWMsR0FBdEIsVUFBdUIsR0FBc0I7UUFDM0MsSUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUMxQixJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ3ZCLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1NBQzdCO1FBQ0QsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDZCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQzdCLE9BQU8sRUFBRSxPQUFPO1NBQ2pCLENBQUMsQ0FBQztRQUNILElBQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0QsSUFBTSxLQUFLLEdBQUcsQ0FBQyxPQUFPLEtBQUssRUFBRSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDNUQsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQ25ELENBQUM7SUFHRDs7OztNQUlFO0lBQ00sd0NBQWlCLEdBQXpCLFVBQTBCLEdBQVE7UUFDaEM7O1dBRUc7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsRUFBRTtZQUNuRCxHQUFHLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ25FO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1lBQ3BDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7U0FDbkU7YUFBTSxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEtBQUssWUFBWSxDQUFDLEVBQUU7WUFDaEcsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUNsRDtRQUVELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM5QixHQUFHLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1NBQzdEO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDN0QsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMseUJBQXlCLEtBQUssV0FBVyxFQUFFO2dCQUN0RixJQUFJLFFBQVEsU0FBQSxFQUFFLFFBQVEsU0FBQSxDQUFDO2dCQUN2QixJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLEVBQUU7b0JBQzVFLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQztvQkFDNUMsUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUM7aUJBQ2pEO3FCQUFNO29CQUNMLFFBQVEsR0FBRyxxQkFBcUIsQ0FBQztvQkFDakMsUUFBUSxHQUFHLFVBQVUsQ0FBQztvQkFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyxxSUFBcUksQ0FBQyxDQUFDO2lCQUNySjtnQkFDRCxHQUFHLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQzthQUM1RjtpQkFBTSxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLHlCQUF5QixLQUFLLGlCQUFpQjtnQkFDbEcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsS0FBSyxXQUFXLENBQUMsRUFBRTtnQkFDL0QsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRTtvQkFDaEQsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7aUJBQzFHO2FBQ0Y7U0FDRjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxpQ0FBVSxHQUFsQixVQUFtQixHQUFXO1FBQzVCLDhCQUE4QjtRQUM5QixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRDs7T0FFRztJQUNLLHlDQUFrQixHQUExQjtRQUNFLElBQUksQ0FBQyxXQUFXLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVEOztPQUVHO0lBQ0ssMENBQW1CLEdBQTNCO1FBQ0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7Ozs7O1FBS0k7SUFDSSw4QkFBTyxHQUFmLFVBQWdCLEtBQXdCLEVBQUUsR0FBcUIsRUFBRSxJQUFpQjtRQUNoRixJQUFJLEtBQUssWUFBWSxpQkFBaUIsRUFBRTtZQUN0QyxJQUF3QixLQUFNLENBQUMsTUFBTSxLQUFLLEdBQUcsSUFBd0IsS0FBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssYUFBYSxFQUFFO2dCQUMzRyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUMzQztpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNyQztTQUNGO2FBQU07WUFDTCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSyx1Q0FBZ0IsR0FBeEIsVUFBeUIsR0FBc0I7UUFDN0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakMsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFDRDs7T0FFRztJQUNLLGdDQUFTLEdBQWpCO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVPLG1DQUFZLEdBQXBCLFVBQXFCLEtBQXdCO1FBQzNDLE9BQU8sVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzNCLENBQUM7O2dCQW5NZ0Msa0JBQWtCO2dCQUFlLFFBQVE7Z0JBQzFDLG9CQUFvQjtnQkFBeUIsYUFBYTs7SUFWL0UsWUFBWTtRQUR4QixVQUFVLEVBQUU7T0FDQSxZQUFZLENBOE14QjtJQUFELG1CQUFDO0NBQUEsQUE5TUQsSUE4TUM7U0E5TVksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgSHR0cEV2ZW50LFxyXG4gIEh0dHBJbnRlcmNlcHRvcixcclxuICBIdHRwSGFuZGxlcixcclxuICBIdHRwUmVxdWVzdCxcclxuICBIdHRwSGVhZGVycyxcclxuICBIdHRwUmVzcG9uc2UsXHJcbiAgSHR0cEVycm9yUmVzcG9uc2UsXHJcbiAgSHR0cENsaWVudFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IE5IVFRQTG9hZGVyU2VydmljZSB9IGZyb20gJy4vbi1IVFRQTG9hZGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XHJcbmltcG9ydCB7IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tc2Vzc2lvblN0b3JhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTlRva2VuU2VydmljZSB9IGZyb20gJy4vbi10b2tlbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTlB1YlN1YlNlcnZpY2UgfSBmcm9tICcuL24tcHViU3ViLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyB0aW1lb3V0LCBjYXRjaEVycm9yLCBmaW5hbGl6ZSwgc3dpdGNoTWFwLCBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOSHR0cFNlcnZpY2Uge1xyXG4gIHRpbWVvdXQgPSA5MDAwMDtcclxuICBzeXN0ZW1TZXJ2aWNlO1xyXG4gIG5TZXNzaW9uU3RvcmFnZTtcclxuICBhcHBQcm9wZXJ0aWVzO1xyXG4gIGlzUmVmcmVzaGluZ1Rva2VuID0gZmFsc2U7XHJcbiAgblB1YlN1YlNlcnZpY2U7XHJcbiAgdG9rZW5TdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPihudWxsKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuSFRUUExvYWRlcjogTkhUVFBMb2FkZXJTZXJ2aWNlLCBwcml2YXRlIGluajogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIG5Mb2NhbFN0b3JhZ2VTZXJ2aWNlOiBOTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBuVG9rZW5TZXJ2aWNlOiBOVG9rZW5TZXJ2aWNlKSB7XHJcbiAgICB0aGlzLnN5c3RlbVNlcnZpY2UgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgdGhpcy5uU2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xyXG4gICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xyXG4gICAgdGhpcy5uUHViU3ViU2VydmljZSA9IG5ldyBOUHViU3ViU2VydmljZSgpO1xyXG4gIH1cclxuXHJcbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XHJcbiAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcigpO1xyXG5cclxuICAgIC8vIFBhc3Mgb24gdGhlIGNsb25lZCByZXF1ZXN0IGluc3RlYWQgb2YgdGhlIG9yaWdpbmFsIHJlcXVlc3QuXHJcbiAgICByZXR1cm4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKVxyXG4gICAgICAucGlwZSh0aW1lb3V0KHRoaXMudGltZW91dClcclxuICAgICAgICAsIGNhdGNoRXJyb3IoZXJyb3IgPT4gdGhpcy5vbkNhdGNoKGVycm9yLCByZXEsIG5leHQpKVxyXG4gICAgICAgICwgZmluYWxpemUoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5vbkZpbmFsbHkoKTtcclxuICAgICAgICB9KSk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVUb2tlbihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UsIHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBhbnkge1xyXG4gICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxyXG4gICAgICB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2xvY2FsQXV0aCcpIHtcclxuICAgICAgaWYgKCF0aGlzLmlzUmVmcmVzaGluZ1Rva2VuKSB7XHJcbiAgICAgICAgdGhpcy5pc1JlZnJlc2hpbmdUb2tlbiA9IHRydWU7XHJcblxyXG4gICAgICAgIC8vIFJlc2V0IGhlcmUgc28gdGhhdCB0aGUgZm9sbG93aW5nIHJlcXVlc3RzIHdhaXQgdW50aWwgdGhlIHRva2VuXHJcbiAgICAgICAgLy8gY29tZXMgYmFjayBmcm9tIHRoZSByZWZyZXNoVG9rZW4gY2FsbC5cclxuICAgICAgICB0aGlzLnRva2VuU3ViamVjdC5uZXh0KG51bGwpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5yZWZyZXNoVG9rZW4oKVxyXG4gICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodG9rZW5zT2JqOiBPYmplY3QpID0+IHtcclxuICAgICAgICAgICAgICBpZiAodG9rZW5zT2JqKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm5Ub2tlblNlcnZpY2UudXBkYXRlVG9rZW5zKHRva2Vuc09iaik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdUb2tlbiA9IHRva2Vuc09ialsnYWNjZXNzVG9rZW4nXTtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9rZW5TdWJqZWN0Lm5leHQobmV3VG9rZW4pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQuaGFuZGxlKHRoaXMucmVxdWVzdE9wdGlvbnMocmVxKSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcignQ2FuXFwndCByZWZyZXNoIHRoZSB0b2tlbicpKTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHRoaXMub25DYXRjaEVycm9yKGVycikpLFxyXG4gICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLmlzUmVmcmVzaGluZ1Rva2VuID0gZmFsc2UpXHJcbiAgICAgICAgICApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRva2VuU3ViamVjdC5waXBlKFxyXG4gICAgICAgICAgZmlsdGVyKHRva2VuID0+IHRva2VuICE9IG51bGwpLFxyXG4gICAgICAgICAgdGFrZSgxKSxcclxuICAgICAgICAgIHN3aXRjaE1hcCh0b2tlbiA9PiBuZXh0LmhhbmRsZSh0aGlzLnJlcXVlc3RPcHRpb25zKHJlcSkpKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm9uQ2F0Y2hFcnJvcihlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWZyZXNoVG9rZW4oKSB7XHJcbiAgICBjb25zdCBodHRwID0gdGhpcy5pbmouZ2V0KEh0dHBDbGllbnQpO1xyXG4gICAgY29uc3QgYXBwUHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3Byb3BlcnRpZXMnKTtcclxuICAgIGNvbnN0IHJlZnJlc2hVcmwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0QXV0aFVybCgpICsgYXBwUHJvcGVydGllcy5hcHBOYW1lICsgJy9yZWZyZXNoJztcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgICdwbGF0Zm9ybURldGFpbHMnOiB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0UGxhdGZvcm1EZXRhaWxzKHRoaXMuc3lzdGVtU2VydmljZS5jaGVja0RldmljZSgpKSxcclxuICAgICAgJ3VzZXJLZXknOiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgndXNlck9iaicpWyd1c2VyS2V5J10sXHJcbiAgICAgICdyZWZyZXNoVG9rZW4nOiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgncmVmcmVzaFRva2VuJylcclxuICAgIH07XHJcbiAgICBib2R5LnBsYXRmb3JtRGV0YWlsc1sndXVpZCddID0gdGhpcy5uTG9jYWxTdG9yYWdlU2VydmljZS5nZXRWYWx1ZSgndXVpZCcpO1xyXG4gICAgcmV0dXJuIGh0dHAucG9zdChyZWZyZXNoVXJsLCBib2R5KTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBSZXF1ZXN0IG9wdGlvbnMuXHJcbiAgICogQHBhcmFtIG9wdGlvbnNcclxuICAgKiBAcmV0dXJucyBIdHRwUmVxdWVzdFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVxdWVzdE9wdGlvbnMocmVxPzogSHR0cFJlcXVlc3Q8YW55Pikge1xyXG4gICAgbGV0IGhlYWRlcnMgPSByZXEuaGVhZGVycztcclxuICAgIGlmIChyZXEuaGVhZGVycyA9PSBudWxsKSB7XHJcbiAgICAgIGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcclxuICAgIH1cclxuICAgIHJlcSA9IHJlcS5jbG9uZSh7XHJcbiAgICAgIHVybDogdGhpcy5nZXRGdWxsVXJsKHJlcS51cmwpLFxyXG4gICAgICBoZWFkZXJzOiBoZWFkZXJzXHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGJhc2VVcmwgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldFZhbCgnYmFzZVVybCcpO1xyXG4gICAgY29uc3QgaXNBcnQgPSAoYmFzZVVybCAhPT0gJycgJiYgcmVxLnVybC5pbmNsdWRlcyhiYXNlVXJsKSk7XHJcbiAgICByZXR1cm4gaXNBcnQgPyB0aGlzLmFkZERlZmF1bHRIZWFkZXJzKHJlcSkgOiByZXE7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgKiBEZWZhdWx0IG9wdGlvbnMuXHJcbiAgKiBAcGFyYW0gb3B0aW9uc1xyXG4gICogQHJldHVybnMgSHR0cEhlYWRlZHJzXHJcbiAgKi9cclxuICBwcml2YXRlIGFkZERlZmF1bHRIZWFkZXJzKHJlcTogYW55KSB7XHJcbiAgICAvKipcclxuICAgICAqIFRPRE86IEFkZCBhbGwgZGVmYXVsdCBIZWFkZXJzIG92ZXIgaGVyZVxyXG4gICAgICovXHJcbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJykpIHtcclxuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicsICcqJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0NvbnRlbnQtVHlwZScpKSB7XHJcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG4gICAgfSBlbHNlIGlmIChyZXEuaGVhZGVycy5oYXMoJ0NvbnRlbnQtVHlwZScpICYmIChyZXEuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpID09PSAnbm8tY29udGVudCcpKSB7XHJcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuZGVsZXRlKCdDb250ZW50LVR5cGUnKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQWNjZXB0JykpIHtcclxuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi9qc29uJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0F1dGhvcml6YXRpb24nKSkge1xyXG4gICAgICB0aGlzLmFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XHJcbiAgICAgIGlmICh0aGlzLmFwcFByb3BlcnRpZXMgJiYgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdiYXNpY0F1dGgnKSB7XHJcbiAgICAgICAgbGV0IHVzZXJuYW1lLCBwYXNzd29yZDtcclxuICAgICAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFVzZXIgJiYgdGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFBhc3N3b3JkKSB7XHJcbiAgICAgICAgICB1c2VybmFtZSA9IHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhVc2VyO1xyXG4gICAgICAgICAgcGFzc3dvcmQgPSB0aGlzLmFwcFByb3BlcnRpZXMuYmFzaWNBdXRoUGFzc3dvcmQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHVzZXJuYW1lID0gXCJiaGl2ZS1hcnQtcHJveHl1c2VyXCI7XHJcbiAgICAgICAgICBwYXNzd29yZCA9IFwicGFzc3dvcmRcIjtcclxuICAgICAgICAgIGNvbnNvbGUud2FybihcIkF1dGhlbnRpY2F0aW9uIHN0cmF0ZWd5OiBCYXNpYyBBdXRoLiBiYXNpY0F1dGhVc2VyIGFuZCBiYXNpY0F1dGhQYXNzd29yZCBhcmUgbm90IGNvbmZpZ3VyZWQgaW4gZW52aXJvbm1lbnQuIFNldHRpbmcgZGVmYXVsdCB2YWx1ZXMuXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCYXNpYyAnICsgYnRvYSh1c2VybmFtZSArIFwiOlwiICsgcGFzc3dvcmQpKTtcclxuICAgICAgfSBlbHNlIGlmICh0aGlzLmFwcFByb3BlcnRpZXMgJiYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxyXG4gICAgICAgIHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnbG9jYWxBdXRoJykpIHtcclxuICAgICAgICBpZiAodGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpIHtcclxuICAgICAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlcTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJ1aWxkIEFQSSB1cmwuXHJcbiAgICogQHBhcmFtIHVybFxyXG4gICAqIEByZXR1cm5zIHN0cmluZ1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnVsbFVybCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAvLyByZXR1cm4gZnVsbCBVUkwgdG8gQVBJIGhlcmVcclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXF1ZXN0IGludGVyY2VwdG9yLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVxdWVzdEludGVyY2VwdG9yKCk6IHZvaWQge1xyXG4gICAgdGhpcy5uSFRUUExvYWRlci5pc0hUVFBSZXF1ZXN0SW5Qcm9ncmVzcyh0cnVlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3BvbnNlIGludGVyY2VwdG9yLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVzcG9uc2VJbnRlcmNlcHRvcigpOiB2b2lkIHtcclxuICAgIHRoaXMubkhUVFBMb2FkZXIuaXNIVFRQUmVxdWVzdEluUHJvZ3Jlc3MoZmFsc2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICAqIEVycm9yIGhhbmRsZXIuXHJcbiAgICAqIEBwYXJhbSBlcnJvclxyXG4gICAgKiBAcGFyYW0gY2F1Z2h0XHJcbiAgICAqIEByZXR1cm5zIEVycm9yT2JzZXJ2YWJsZVxyXG4gICAgKi9cclxuICBwcml2YXRlIG9uQ2F0Y2goZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlLCByZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEh0dHBFcnJvclJlc3BvbnNlKSB7XHJcbiAgICAgIGlmICgoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5zdGF0dXMgPT09IDQwMyAmJiAoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5lcnJvci5tZXNzYWdlID09PSAnand0IGV4cGlyZWQnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlVG9rZW4oZXJyb3IsIHJlcSwgbmV4dCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub25TdWJzY3JpYmVFcnJvcihlcnJvcik7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm9uU3Vic2NyaWJlRXJyb3IoZXJyb3IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogb25TdWJzY3JpYmVFcnJvclxyXG4gICAqIEBwYXJhbSBlcnJvclxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25TdWJzY3JpYmVFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHRoaXMubkhUVFBMb2FkZXIuYWxlcnRFcnJvcihlcnIpO1xyXG4gICAgcmV0dXJuIHRoaXMub25DYXRjaEVycm9yKGVycik7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIG9uRmluYWxseVxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25GaW5hbGx5KCk6IHZvaWQge1xyXG4gICAgdGhpcy5yZXNwb25zZUludGVyY2VwdG9yKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uQ2F0Y2hFcnJvcihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19