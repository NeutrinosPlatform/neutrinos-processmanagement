import { __decorate } from "tslib";
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig, Driver } from 'ngforage';
import { NUtility } from './n-util.service';
var NLocalStorageService = /** @class */ (function () {
    function NLocalStorageService(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    NLocalStorageService.prototype.initStorage = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova']) {
                _this.initNgForage();
            }
            _this.ngf.iterate(function (value, key, iteratonNumber) {
                _this.storageCache[key] = value;
            }).then(function (result) {
                _this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(function (error) {
                return reject(error);
            });
        });
    };
    NLocalStorageService.prototype.getStorage = function () {
        return this.storageCache;
    };
    NLocalStorageService.prototype.setValue = function (key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(function (result) {
            return result;
        }, function (error) {
            console.log(error);
        });
    };
    NLocalStorageService.prototype.getValue = function (key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            var obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (error) {
            return this.storageCache[key];
        }
    };
    NLocalStorageService.prototype.remove = function (key) {
        var _this = this;
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(function (fulfilled) {
            delete _this.ngf[key];
        }).catch(function (error) {
            console.error('Could not remove', key);
        });
    };
    NLocalStorageService.prototype.clear = function () {
        this.storageCache = {};
        this.ngf.clear();
    };
    NLocalStorageService.prototype.pluginCheck = function () {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    };
    NLocalStorageService.prototype.getItemNs = function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.getItem(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.setItemNs = function (key, value) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.setItem(key, value, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.removeItemNs = function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.remove(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.clearNs = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.clear(function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    NLocalStorageService.prototype.initNgForage = function () {
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                Driver.WEB_SQL,
            ]
        });
    };
    NLocalStorageService.prototype.promiseReflect = function (promise) {
        return promise.then(function (resolved) { return { v: resolved, status: 'resolved' }; }, function (error) { return { e: error, status: 'rejected' }; });
    };
    NLocalStorageService.prototype.clearLocalStorage = function () {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    };
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
    */
    NLocalStorageService.prototype.checkDeviceId = function () {
        var _this = this;
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get(function (uuid) {
                _this._deviceUUID = uuid;
                _this.setValue('uuid', _this._deviceUUID);
            });
        }
        return this._deviceUUID;
    };
    Object.defineProperty(NLocalStorageService.prototype, "deviceUUID", {
        get: function () {
            return this._deviceUUID;
        },
        enumerable: true,
        configurable: true
    });
    NLocalStorageService.ctorParameters = function () { return [
        { type: NgForageConfig },
        { type: NgForage },
        { type: NgForageCache }
    ]; };
    NLocalStorageService = __decorate([
        Injectable()
    ], NLocalStorageService);
    return NLocalStorageService;
}());
export { NLocalStorageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUMsUUFBUSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUc1QztJQUtFLDhCQUFvQixTQUEwQixFQUFtQixHQUFjLEVBQW1CLFFBQXdCO1FBQXRHLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQW1CLFFBQUcsR0FBSCxHQUFHLENBQVc7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBZ0I7UUFIMUgsaUJBQVksR0FBUSxFQUFFLENBQUM7SUFJdkIsQ0FBQztJQUlELDBDQUFXLEdBQVg7UUFBQSxpQkFjQztRQWJDLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDckIsS0FBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1lBQ0QsS0FBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLGNBQWM7Z0JBQzFDLEtBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07Z0JBQ1osS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNyQixPQUFPLE9B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SyxTQUFTLEVBQUU7WUFDNUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXpDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksUUFBUSxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN6QztTQUNGO2FBQU07WUFDTCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxVQUFDLElBQUk7Z0JBQ3hDLEtBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUN4QixLQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxLQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsc0JBQVcsNENBQVU7YUFBckI7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQzs7O09BQUE7O2dCQXRLK0IsY0FBYztnQkFBeUIsUUFBUTtnQkFBOEIsYUFBYTs7SUFML0csb0JBQW9CO1FBRGhDLFVBQVUsRUFBRTtPQUNBLG9CQUFvQixDQTRLaEM7SUFBRCwyQkFBQztDQUFBLEFBNUtELElBNEtDO1NBNUtZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5TeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi9uLXN5c3RlbS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge05nRm9yYWdlLCBOZ0ZvcmFnZUNhY2hlLCBOZ0ZvcmFnZUNvbmZpZywgRHJpdmVyfSBmcm9tICduZ2ZvcmFnZSc7XHJcbmltcG9ydCB7IE5VdGlsaXR5IH0gZnJvbSAnLi9uLXV0aWwuc2VydmljZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOTG9jYWxTdG9yYWdlU2VydmljZSB7XHJcblxyXG4gIHN0b3JhZ2VDYWNoZTogYW55ID0ge307XHJcbiAgcHJpdmF0ZSBfZGV2aWNlVVVJRDtcclxuICBwcml2YXRlIG5hdGl2ZVN0b3JhZ2VJO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdmQ29uZmlnPzogTmdGb3JhZ2VDb25maWcsIHByaXZhdGUgcmVhZG9ubHkgbmdmPzogTmdGb3JhZ2UsIHByaXZhdGUgcmVhZG9ubHkgbmdmQ2FjaGU/OiBOZ0ZvcmFnZUNhY2hlKSB7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIGluaXRTdG9yYWdlKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XHJcbiAgICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLm5nZi5pdGVyYXRlKCh2YWx1ZSwga2V5LCBpdGVyYXRvbk51bWJlcikgPT4ge1xyXG4gICAgICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcclxuICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgIHRoaXMuY2hlY2tEZXZpY2VJZCgpO1xyXG4gICAgICAgIHJldHVybiByZXNvbHZlKCdpdGVyYXRpb24gaXMgY29tcGxldGVkJylcclxuICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0U3RvcmFnZSgpIHtcclxuICAgIHJldHVybiB0aGlzLnN0b3JhZ2VDYWNoZTtcclxuICB9XHJcblxyXG5cclxuICBzZXRWYWx1ZShrZXksIHZhbHVlKSB7XHJcbiAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10pIHtcclxuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcclxuICAgIHJldHVybiB0aGlzLm5nZi5zZXRJdGVtKGtleSwgdmFsdWUpLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRWYWx1ZShrZXkpOiBhbnkgfCBQcm9taXNlPGFueT4ge1xyXG4gICAgaWYgKCF0aGlzLnN0b3JhZ2VDYWNoZVtrZXldKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfSB0cnkge1xyXG4gICAgICBjb25zdCBvYmogPSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldXHJcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKG9iaik7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbW92ZShrZXkpIHtcclxuICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldO1xyXG4gICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XHJcbiAgICAgIHRoaXMuaW5pdE5nRm9yYWdlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm5nZi5yZW1vdmVJdGVtKGtleSkudGhlbihmdWxmaWxsZWQgPT4ge1xyXG4gICAgICBkZWxldGUgdGhpcy5uZ2Zba2V5XTtcclxuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgY29uc29sZS5lcnJvcignQ291bGQgbm90IHJlbW92ZScsIGtleSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGNsZWFyKCkge1xyXG4gICAgdGhpcy5zdG9yYWdlQ2FjaGUgPSB7fTtcclxuICAgIHRoaXMubmdmLmNsZWFyKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBsdWdpbkNoZWNrKCkge1xyXG4gICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XHJcbiAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkgPSB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXTtcclxuICAgICAgLy8gcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICAvLyB0aGlzLmluaXRTdG9yYWdlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEl0ZW1OcyhrZXkpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xyXG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuZ2V0SXRlbShrZXksIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRJdGVtTnMoa2V5LCB2YWx1ZSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XHJcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5zZXRJdGVtKGtleSwgdmFsdWUsIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVJdGVtTnMoa2V5KSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcclxuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLnJlbW92ZShrZXksIChyZXN1bHQpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICB9LCAoZXJyb3IpID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNsZWFyTnMoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcclxuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLmNsZWFyKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0TmdGb3JhZ2UoKSB7XHJcbiAgICB0aGlzLm5nZkNvbmZpZy5jb25maWd1cmUoe1xyXG4gICAgICBuYW1lOiAnTXlBcHAnLFxyXG4gICAgICBkcml2ZXI6IFtcclxuICAgICAgICBEcml2ZXIuV0VCX1NRTCxcclxuICAgICAgXVxyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwcm9taXNlUmVmbGVjdChwcm9taXNlKSB7XHJcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKHJlc29sdmVkID0+IHsgcmV0dXJuIHsgdjogcmVzb2x2ZWQsIHN0YXR1czogJ3Jlc29sdmVkJyB9IH0sIGVycm9yID0+IHsgcmV0dXJuIHsgZTogZXJyb3IsIHN0YXR1czogJ3JlamVjdGVkJyB9IH0pXHJcbiAgfVxyXG5cclxuICBjbGVhckxvY2FsU3RvcmFnZSgpIHtcclxuICAgIHRoaXMucmVtb3ZlKCd1c2VyT2JqJyk7XHJcbiAgICB0aGlzLnJlbW92ZSgnYWNjZXNzVG9rZW4nKTtcclxuICAgIHRoaXMucmVtb3ZlKCdyZWZyZXNoVG9rZW4nKTtcclxuICAgIHRoaXMucmVtb3ZlKCdyZWdpc3RyYXRpb25JZCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRHVlIHRvIHRpbWluZyBpc3N1ZXMgYW5kIGNpcmN1bGFyIGRlcGVuZGVuY3kgY2hlY2tEZXZpY2VJZCBpcyBtb3ZlZCBmcm9tIE5TeXN0ZW1TZXJ2aWNlXHJcbiAgKi9cclxuXHJcbiAgY2hlY2tEZXZpY2VJZCgpIHtcclxuICAgIGlmIChOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmNoZWNrRGV2aWNlKCkgPT09ICdicm93c2VyJykge1xyXG4gICAgICB0aGlzLl9kZXZpY2VVVUlEID0gdGhpcy5nZXRWYWx1ZSgndXVpZCcpO1xyXG5cclxuICAgICAgaWYgKCF0aGlzLl9kZXZpY2VVVUlEKSB7XHJcbiAgICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IG5ldyBOVXRpbGl0eSgpLmdlbmVyYXRlVVVJRCgpO1xyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUoJ3V1aWQnLCB0aGlzLl9kZXZpY2VVVUlEKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgd2luZG93WydwbHVnaW5zJ10udW5pcXVlRGV2aWNlSUQuZ2V0KCh1dWlkKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHV1aWQ7XHJcbiAgICAgICAgdGhpcy5zZXRWYWx1ZSgndXVpZCcsIHRoaXMuX2RldmljZVVVSUQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9kZXZpY2VVVUlEO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBkZXZpY2VVVUlEKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2RldmljZVVVSUQ7XHJcbiAgfVxyXG59XHJcbiJdfQ==