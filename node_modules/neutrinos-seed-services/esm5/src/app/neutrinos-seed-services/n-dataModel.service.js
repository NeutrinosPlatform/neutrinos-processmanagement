import { __decorate } from "tslib";
import { HttpClient } from '@angular/common/http';
import { throwError } from 'rxjs';
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { map, catchError } from 'rxjs/operators';
var NDataModelService = /** @class */ (function () {
    function NDataModelService(http) {
        this.http = http;
        this.invalidDataModelName = 'Invalid data model name.';
        this.invalidDataModelId = 'Invalid data model id.';
        this.invalidDataModelObj = 'Invalid data model object.';
        this.systemService = NSystemService.getInstance();
    }
    // GET /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName
     * @param filter The filter query parameter allows to specify conditions on the documents to return.
     * The filter qparam value is any mongodb queryâ€¦ Defaults to {}
     * @param keys Projections to be applited on mongo db.
     * @param sort sort to be applied on the query results. Defaults to {}
     * @param pagenumber Page number for paginated queries. Defaults to 1
     * @param pagesize Size of each page to be returned. Defaults to 100.
     */
    NDataModelService.prototype.get = function (dataModelName, filter, keys, sort, pagenumber, pagesize) {
        if (dataModelName) {
            // let modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) || this.checkIfValid(keys) || this.checkIfValid(sort) ||
                this.checkIfValid(pagenumber) || this.checkIfValid(pagesize)) {
                var queryString = "" + this.toQueryString({
                    'filter': filter,
                    'keys': keys,
                    'sort': sort,
                    'pagenumber': pagenumber,
                    'pagesize': pagesize
                });
                if (queryString === '') {
                    queryString += '?filter={}';
                }
                else {
                    queryString = '?'.concat(queryString);
                }
                modelNameUrl += queryString;
            }
            return this.http.get(modelNameUrl).pipe(map(function (value, index) {
                return value;
            }), catchError(function (error) {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error("Could not get " + dataModelName + ". " + this.invalidDataModelName));
        }
    };
    // PUT /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName Data model name of the app
     * @param dataModelObj Data Model object which is to be inserted
     */
    NDataModelService.prototype.put = function (dataModelName, dataModelObj) {
        if (dataModelName) {
            if (dataModelObj) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
                var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
                return this.http.put(modelNameUrl, dataModelObj).pipe(map(function (value, index) {
                    return value;
                }), catchError(function (error) {
                    return throwError(error);
                }));
            }
            else {
                return throwError(new Error("Could not put " + dataModelObj + " in " + dataModelName + ". " + this.invalidDataModelObj));
            }
        }
        else {
            return throwError(new Error("Could not put " + dataModelObj + " in " + dataModelName + ". " + this.invalidDataModelName));
        }
    };
    // DELETE /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName
     * @param filter
     */
    NDataModelService.prototype.delete = function (dataModelName, filter) {
        var modelNameUrl;
        if (dataModelName) {
            // modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) && filter != '') {
                modelNameUrl += "?filter=" + filter;
            }
            else {
                modelNameUrl += '?filter={}';
            }
            return this.http.delete(modelNameUrl).pipe(map(function (value, index) {
                return value;
            }), catchError(function (error) {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error("Could not delete " + dataModelName + ". " + this.invalidDataModelName));
        }
    };
    // PATCH /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}
    /**
     *
     * @param dataModelName Data model name which is to be updated
     * @param dataModelObj New data model object
     */
    NDataModelService.prototype.update = function (dataModelName, updateObject) {
        if (dataModelName && updateObject) {
            // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            return this.http.patch(modelNameUrl, updateObject).pipe(map(function (value, index) {
                return value;
            }), catchError(function (error) {
                return throwError(error);
            }));
        }
        else {
            return throwError(new Error("Could not update " + dataModelName + ". " + this.invalidDataModelName));
        }
    };
    // GET /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be updated
     * @param dataModelId Data model id which is to be updated
     */
    NDataModelService.prototype.getById = function (dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.get(modelNameUrl).pipe(map(function (value, index) {
                    return value;
                }), catchError(function (error) {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error("Could not get " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelId));
            }
        }
        else {
            throwError(new Error("Could not get " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelName));
        }
    };
    // DELETE /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be deleted
     * @param dataModelId Data model id which is to be deleted
     */
    NDataModelService.prototype.deleteById = function (dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.delete(modelNameUrl).pipe(map(function (value, index) {
                    return value;
                }), catchError(function (error) {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error("Could not get " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelId));
            }
        }
        else {
            return throwError(new Error("Could not delete " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelName));
        }
    };
    //PATCH /{tenantName}/datamodel/{datasource}/{appName}/{dataModelName}/{dataModelId}
    /**
     *
     * @param dataModelName Data model name which is to be update
     * @param dataModelId Data model id which is to be updated
     * @param dataModelObj Data Model object which is to be inserted
     */
    NDataModelService.prototype.updateById = function (dataModelName, dataModelId, dataModelObj) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                var modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                var dmObj = Object.assign({}, dataModelObj);
                delete dmObj['_id'];
                return this.http.patch(modelNameUrl, dmObj).pipe(map(function (value, index) {
                    return value;
                }), catchError(function (error) {
                    return throwError(error);
                }));
            }
            else {
                throwError(new Error("Could not get " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelId));
            }
        }
        else {
            return throwError(new Error("Could not delete " + dataModelName + " by id " + dataModelId + ". " + this.invalidDataModelName));
        }
    };
    NDataModelService.prototype.toQueryString = function (obj) {
        var parts = [];
        for (var i in obj) {
            if (obj.hasOwnProperty(i) && this.checkIfValid(obj[i])) {
                parts.push((i) + '=' + JSON.stringify(obj[i]));
            }
        }
        return parts.join('&');
    };
    NDataModelService.prototype.checkIfValid = function (value) {
        if (value === undefined || value == null) {
            return false;
        }
        else {
            return true;
        }
    };
    NDataModelService.prototype.getDataSourceURL = function (dataModelName) {
        if (!this.dmDs) {
            this.dmDs = window['neutrinos']['dataSource'];
        }
        var dsDm = this.dmDs[dataModelName];
        var properties = this.systemService.properties;
        if (dsDm) {
            return properties.baseUrl + properties.tenantName + '/datamodel/' + dsDm + '/' + properties.appName + '/';
        }
        else {
            return this.systemService.getDataModelUrl();
        }
    };
    NDataModelService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    NDataModelService = __decorate([
        Injectable()
    ], NDataModelService);
    return NDataModelService;
}());
export { NDataModelService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1kYXRhTW9kZWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWRhdGFNb2RlbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR2pEO0lBT0UsMkJBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFKNUIseUJBQW9CLEdBQVcsMEJBQTBCLENBQUM7UUFDMUQsdUJBQWtCLEdBQVcsd0JBQXdCLENBQUM7UUFDdEQsd0JBQW1CLEdBQVcsNEJBQTRCLENBQUM7UUFHakUsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEQsQ0FBQztJQUVELHFFQUFxRTtJQUNyRTs7Ozs7Ozs7O09BU0c7SUFDSCwrQkFBRyxHQUFILFVBQUksYUFBYSxFQUFFLE1BQU8sRUFBRSxJQUFLLEVBQUUsSUFBSyxFQUFFLFVBQVcsRUFBRSxRQUFTO1FBQzlELElBQUksYUFBYSxFQUFFO1lBQ2pCLGdGQUFnRjtZQUNoRixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDO1lBQ3hFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUks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QUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7UUFDakQsSUFBSSxJQUFJLEVBQUU7WUFDUixPQUFPLFVBQVUsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsR0FBRyxhQUFhLEdBQUcsSUFBSSxHQUFHLEdBQUcsR0FBRyxVQUFVLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztTQUMzRzthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsRUFBRSxDQUFDO1NBQzdDO0lBQ0gsQ0FBQzs7Z0JBNU55QixVQUFVOztJQVB6QixpQkFBaUI7UUFEN0IsVUFBVSxFQUFFO09BQ0EsaUJBQWlCLENBc083QjtJQUFELHdCQUFDO0NBQUEsQUF0T0QsSUFzT0M7U0F0T1ksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5TeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi9uLXN5c3RlbS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgbWFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTkRhdGFNb2RlbFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgc3lzdGVtU2VydmljZTogTlN5c3RlbVNlcnZpY2U7XHJcbiAgcHJpdmF0ZSBkbVVybDogc3RyaW5nO1xyXG4gIHByaXZhdGUgaW52YWxpZERhdGFNb2RlbE5hbWU6IHN0cmluZyA9ICdJbnZhbGlkIGRhdGEgbW9kZWwgbmFtZS4nO1xyXG4gIHByaXZhdGUgaW52YWxpZERhdGFNb2RlbElkOiBzdHJpbmcgPSAnSW52YWxpZCBkYXRhIG1vZGVsIGlkLic7XHJcbiAgcHJpdmF0ZSBpbnZhbGlkRGF0YU1vZGVsT2JqOiBzdHJpbmcgPSAnSW52YWxpZCBkYXRhIG1vZGVsIG9iamVjdC4nO1xyXG4gIHByaXZhdGUgZG1EcztcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcclxuICAgIHRoaXMuc3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbiAgfVxyXG5cclxuICAvLyBHRVQgL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lXHJcbiAgICogQHBhcmFtIGZpbHRlciBUaGUgZmlsdGVyIHF1ZXJ5IHBhcmFtZXRlciBhbGxvd3MgdG8gc3BlY2lmeSBjb25kaXRpb25zIG9uIHRoZSBkb2N1bWVudHMgdG8gcmV0dXJuLlxyXG4gICAqIFRoZSBmaWx0ZXIgcXBhcmFtIHZhbHVlIGlzIGFueSBtb25nb2RiIHF1ZXJ54oCmIERlZmF1bHRzIHRvIHt9XHJcbiAgICogQHBhcmFtIGtleXMgUHJvamVjdGlvbnMgdG8gYmUgYXBwbGl0ZWQgb24gbW9uZ28gZGIuXHJcbiAgICogQHBhcmFtIHNvcnQgc29ydCB0byBiZSBhcHBsaWVkIG9uIHRoZSBxdWVyeSByZXN1bHRzLiBEZWZhdWx0cyB0byB7fVxyXG4gICAqIEBwYXJhbSBwYWdlbnVtYmVyIFBhZ2UgbnVtYmVyIGZvciBwYWdpbmF0ZWQgcXVlcmllcy4gRGVmYXVsdHMgdG8gMVxyXG4gICAqIEBwYXJhbSBwYWdlc2l6ZSBTaXplIG9mIGVhY2ggcGFnZSB0byBiZSByZXR1cm5lZC4gRGVmYXVsdHMgdG8gMTAwLlxyXG4gICAqL1xyXG4gIGdldChkYXRhTW9kZWxOYW1lLCBmaWx0ZXI/LCBrZXlzPywgc29ydD8sIHBhZ2VudW1iZXI/LCBwYWdlc2l6ZT8pOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcclxuICAgICAgLy8gbGV0IG1vZGVsTmFtZVVybCA9IGAke3RoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKX0ke2RhdGFNb2RlbE5hbWV9YDtcclxuICAgICAgbGV0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWU7XHJcbiAgICAgIGlmICh0aGlzLmNoZWNrSWZWYWxpZChmaWx0ZXIpIHx8IHRoaXMuY2hlY2tJZlZhbGlkKGtleXMpIHx8IHRoaXMuY2hlY2tJZlZhbGlkKHNvcnQpIHx8XHJcbiAgICAgICAgdGhpcy5jaGVja0lmVmFsaWQocGFnZW51bWJlcikgfHwgdGhpcy5jaGVja0lmVmFsaWQocGFnZXNpemUpKSB7XHJcbiAgICAgICAgbGV0IHF1ZXJ5U3RyaW5nID0gYCR7dGhpcy50b1F1ZXJ5U3RyaW5nKHtcclxuICAgICAgICAgICdmaWx0ZXInOiBmaWx0ZXIsXHJcbiAgICAgICAgICAna2V5cyc6IGtleXMsXHJcbiAgICAgICAgICAnc29ydCc6IHNvcnQsXHJcbiAgICAgICAgICAncGFnZW51bWJlcic6IHBhZ2VudW1iZXIsXHJcbiAgICAgICAgICAncGFnZXNpemUnOiBwYWdlc2l6ZVxyXG4gICAgICAgIH0pfWA7XHJcbiAgICAgICAgaWYgKHF1ZXJ5U3RyaW5nID09PSAnJykge1xyXG4gICAgICAgICAgcXVlcnlTdHJpbmcgKz0gJz9maWx0ZXI9e30nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBxdWVyeVN0cmluZyA9ICc/Jy5jb25jYXQocXVlcnlTdHJpbmcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBtb2RlbE5hbWVVcmwgKz0gcXVlcnlTdHJpbmc7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQobW9kZWxOYW1lVXJsKS5waXBlKG1hcCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9KSwgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gICAgICB9KSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFBVVCAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWUgRGF0YSBtb2RlbCBuYW1lIG9mIHRoZSBhcHBcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsT2JqIERhdGEgTW9kZWwgb2JqZWN0IHdoaWNoIGlzIHRvIGJlIGluc2VydGVkXHJcbiAgICovXHJcbiAgcHV0KGRhdGFNb2RlbE5hbWUsIGRhdGFNb2RlbE9iaik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xyXG4gICAgICBpZiAoZGF0YU1vZGVsT2JqKSB7XHJcbiAgICAgICAgLy8gY29uc3QgbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX1gO1xyXG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQobW9kZWxOYW1lVXJsLCBkYXRhTW9kZWxPYmopLnBpcGUobWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KSwgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IHB1dCAke2RhdGFNb2RlbE9ian0gaW4gJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxPYmp9YCkpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBwdXQgJHtkYXRhTW9kZWxPYmp9IGluICR7ZGF0YU1vZGVsTmFtZX0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBERUxFVEUgL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX1cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lXHJcbiAgICogQHBhcmFtIGZpbHRlclxyXG4gICAqL1xyXG4gIGRlbGV0ZShkYXRhTW9kZWxOYW1lLCBmaWx0ZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgbGV0IG1vZGVsTmFtZVVybDtcclxuICAgIGlmIChkYXRhTW9kZWxOYW1lKSB7XHJcbiAgICAgIC8vIG1vZGVsTmFtZVVybCA9IGAke3RoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKX0ke2RhdGFNb2RlbE5hbWV9YDtcclxuICAgICAgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZTtcclxuXHJcbiAgICAgIGlmICh0aGlzLmNoZWNrSWZWYWxpZChmaWx0ZXIpICYmIGZpbHRlciAhPSAnJykge1xyXG4gICAgICAgIG1vZGVsTmFtZVVybCArPSBgP2ZpbHRlcj0ke2ZpbHRlcn1gO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1vZGVsTmFtZVVybCArPSAnP2ZpbHRlcj17fSc7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUobW9kZWxOYW1lVXJsKS5waXBlKG1hcCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9KSwgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gICAgICB9KSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBkZWxldGUgJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFBBVENIIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxPYmogTmV3IGRhdGEgbW9kZWwgb2JqZWN0XHJcbiAgICovXHJcbiAgdXBkYXRlKGRhdGFNb2RlbE5hbWUsIHVwZGF0ZU9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSAmJiB1cGRhdGVPYmplY3QpIHtcclxuICAgICAgLy8gY29uc3QgbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX1gO1xyXG4gICAgICBjb25zdCBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lO1xyXG4gICAgICByZXR1cm4gdGhpcy5odHRwLnBhdGNoKG1vZGVsTmFtZVVybCwgdXBkYXRlT2JqZWN0KS5waXBlKG1hcCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9KSwgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xyXG4gICAgICB9KSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCB1cGRhdGUgJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIEdFVCAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfS97ZGF0YU1vZGVsSWR9XHJcbiAgLyoqXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxJZCBEYXRhIG1vZGVsIGlkIHdoaWNoIGlzIHRvIGJlIHVwZGF0ZWRcclxuICAgKi9cclxuICBnZXRCeUlkKGRhdGFNb2RlbE5hbWUsIGRhdGFNb2RlbElkKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChkYXRhTW9kZWxOYW1lKSB7XHJcbiAgICAgIGlmIChkYXRhTW9kZWxJZCkge1xyXG4gICAgICAgIC8vIGNvbnN0IG1vZGVsTmFtZVVybCA9IGAke3RoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKX0ke2RhdGFNb2RlbE5hbWV9LyR7ZGF0YU1vZGVsSWR9YDtcclxuICAgICAgICBjb25zdCBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lICsgXCIvXCIgKyBkYXRhTW9kZWxJZDtcclxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldChtb2RlbE5hbWVVcmwpLnBpcGUobWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9KSwgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxJZH1gKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93RXJyb3IobmV3IEVycm9yKGBDb3VsZCBub3QgZ2V0ICR7ZGF0YU1vZGVsTmFtZX0gYnkgaWQgJHtkYXRhTW9kZWxJZH0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBERUxFVEUgL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX0ve2RhdGFNb2RlbElkfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWUgRGF0YSBtb2RlbCBuYW1lIHdoaWNoIGlzIHRvIGJlIGRlbGV0ZWRcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsSWQgRGF0YSBtb2RlbCBpZCB3aGljaCBpcyB0byBiZSBkZWxldGVkXHJcbiAgICovXHJcbiAgZGVsZXRlQnlJZChkYXRhTW9kZWxOYW1lLCBkYXRhTW9kZWxJZCkge1xyXG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcclxuICAgICAgaWYgKGRhdGFNb2RlbElkKSB7XHJcbiAgICAgICAgLy8gY29uc3QgbW9kZWxOYW1lVXJsID0gYCR7dGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpfSR7ZGF0YU1vZGVsTmFtZX0vJHtkYXRhTW9kZWxJZH1gO1xyXG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWUgKyBcIi9cIiArIGRhdGFNb2RlbElkO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlKG1vZGVsTmFtZVVybCkucGlwZShtYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93RXJyb3IobmV3IEVycm9yKGBDb3VsZCBub3QgZ2V0ICR7ZGF0YU1vZGVsTmFtZX0gYnkgaWQgJHtkYXRhTW9kZWxJZH0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsSWR9YCkpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBkZWxldGUgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vUEFUQ0ggL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX0ve2RhdGFNb2RlbElkfVxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWUgRGF0YSBtb2RlbCBuYW1lIHdoaWNoIGlzIHRvIGJlIHVwZGF0ZVxyXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxJZCBEYXRhIG1vZGVsIGlkIHdoaWNoIGlzIHRvIGJlIHVwZGF0ZWRcclxuICAgKiBAcGFyYW0gZGF0YU1vZGVsT2JqIERhdGEgTW9kZWwgb2JqZWN0IHdoaWNoIGlzIHRvIGJlIGluc2VydGVkXHJcbiAgICovXHJcbiAgdXBkYXRlQnlJZChkYXRhTW9kZWxOYW1lLCBkYXRhTW9kZWxJZCwgZGF0YU1vZGVsT2JqKSB7XHJcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xyXG4gICAgICBpZiAoZGF0YU1vZGVsSWQpIHtcclxuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfS8ke2RhdGFNb2RlbElkfWA7XHJcbiAgICAgICAgY29uc3QgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZSArIFwiL1wiICsgZGF0YU1vZGVsSWQ7XHJcbiAgICAgICAgdmFyIGRtT2JqID0gT2JqZWN0LmFzc2lnbih7fSwgZGF0YU1vZGVsT2JqKTtcclxuICAgICAgICBkZWxldGUgZG1PYmpbJ19pZCddO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucGF0Y2gobW9kZWxOYW1lVXJsLCBkbU9iaikucGlwZShtYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0pLCBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3dFcnJvcihuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxJZH1gKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5ldyBFcnJvcihgQ291bGQgbm90IGRlbGV0ZSAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0b1F1ZXJ5U3RyaW5nKG9iaikge1xyXG4gICAgY29uc3QgcGFydHMgPSBbXTtcclxuICAgIGZvciAoY29uc3QgaSBpbiBvYmopIHtcclxuICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShpKSAmJiB0aGlzLmNoZWNrSWZWYWxpZChvYmpbaV0pKSB7XHJcbiAgICAgICAgcGFydHMucHVzaCgoaSkgKyAnPScgKyBKU09OLnN0cmluZ2lmeShvYmpbaV0pKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhcnRzLmpvaW4oJyYnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tJZlZhbGlkKHZhbHVlOiBhbnkpIHtcclxuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkge1xyXG4gICAgaWYgKCF0aGlzLmRtRHMpIHtcclxuICAgICAgdGhpcy5kbURzID0gd2luZG93WyduZXV0cmlub3MnXVsnZGF0YVNvdXJjZSddO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZHNEbSA9IHRoaXMuZG1Ec1tkYXRhTW9kZWxOYW1lXTtcclxuICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UucHJvcGVydGllcztcclxuICAgIGlmIChkc0RtKSB7XHJcbiAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmJhc2VVcmwgKyBwcm9wZXJ0aWVzLnRlbmFudE5hbWUgKyAnL2RhdGFtb2RlbC8nICsgZHNEbSArICcvJyArIHByb3BlcnRpZXMuYXBwTmFtZSArICcvJztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0RGF0YU1vZGVsVXJsKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbn1cclxuIl19