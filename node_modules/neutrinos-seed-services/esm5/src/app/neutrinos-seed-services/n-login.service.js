import { __decorate } from "tslib";
import { map } from 'rxjs/operators';
import { Injectable, EventEmitter, Output } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { NSystemService } from './n-system.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NNotificationService } from './n-notification.service';
var NLoginService = /** @class */ (function () {
    function NLoginService(http, pubSubService, notificationService, nLocalStorageService, nTokenService) {
        this.http = http;
        this.pubSubService = pubSubService;
        this.notificationService = notificationService;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.loginCompleted = new EventEmitter();
        this.systemService = NSystemService.getInstance();
        // this.nTokenService = new NTokenService();
        this.nSessionStorage = new NSessionStorageService();
        // this.nLocalStorageService = new NLocalStorageService();
    }
    NLoginService.prototype.login = function (userName, password, isRemember) {
        var _this = this;
        this.appProperties = this.systemService.getVal('properties');
        this.loginUrl = this.systemService.getAuthUrl() + this.appProperties.appName;
        this.uuid = this.nLocalStorageService.getValue('uuid');
        if (!this.uuid) {
            this.uuid = this.nLocalStorageService.checkDeviceId();
        }
        this.details = {
            username: userName,
            password: password,
        };
        this.details.platformDetails = this.systemService.getPlatformDetails(this.systemService.checkDevice());
        this.details.platformDetails['uuid'] = this.uuid;
        return this.http.post(this.loginUrl, JSON.stringify(this.details)).pipe(map(function (result) {
            var tokensObj = result;
            if (tokensObj) {
                _this.nTokenService.updateTokens(tokensObj, isRemember);
            }
            // TODO chris array of supported pushes currently only support APNS and Firebase
            if ((_this.systemService.getVal('firebaseSenderId') != 'FIREBASE_SENDER_ID' && _this.systemService.getVal('firebaseAuthKey') != 'FIREBASE_AUTH_KEY')
                || (_this.systemService.getVal('pushType') === 'APNS' && _this.systemService.isIOS())) {
                _this.pubSubService.$pub('firebaseRegister');
            }
            _this.pubSubService.$pub('loginComplete');
            return (result);
        }, function (error) {
            return (error);
        }));
    };
    NLoginService.prototype.isLoggedIn = function () {
        var _this = this;
        return this.nLocalStorageService.initStorage().then(function (result) {
            if (_this.nSessionStorage.getValue('accessToken') && _this.nSessionStorage.getValue('refreshToken') &&
                _this.nSessionStorage.getValue('accessToken') != 'null' && _this.nSessionStorage.getValue('refreshToken') != 'null') {
                return true;
            }
            return false;
        }).catch(function (error) {
            return false;
        });
    };
    NLoginService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: NPubSubService },
        { type: NNotificationService },
        { type: NLocalStorageService },
        { type: NTokenService }
    ]; };
    __decorate([
        Output()
    ], NLoginService.prototype, "loginCompleted", void 0);
    NLoginService = __decorate([
        Injectable()
    ], NLoginService);
    return NLoginService;
}());
export { NLoginService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2dpbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL24tbG9naW4uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFNaEU7SUFTRSx1QkFBb0IsSUFBZ0IsRUFBVSxhQUE2QixFQUFVLG1CQUF5QyxFQUNwSCxvQkFBMEMsRUFBVSxhQUE0QjtRQUR0RSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQVUsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtRQUNwSCx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFGaEYsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xELDRDQUE0QztR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QUNiO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQSxLQUFLO1lBQ1osT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztJQUVMLENBQUM7O2dCQWxEeUIsVUFBVTtnQkFBeUIsY0FBYztnQkFBK0Isb0JBQW9CO2dCQUM5RixvQkFBb0I7Z0JBQXlCLGFBQWE7O0lBRmhGO1FBQVQsTUFBTSxFQUFFO3lEQUFxQztJQVJuQyxhQUFhO1FBRHpCLFVBQVUsRUFBRTtPQUNBLGFBQWEsQ0E0RHpCO0lBQUQsb0JBQUM7Q0FBQSxBQTVERCxJQTREQztTQTVEWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XHJcbmltcG9ydCB7IE5Ub2tlblNlcnZpY2UgfSBmcm9tICcuL24tdG9rZW4uc2VydmljZSc7XHJcbmltcG9ydCB7IE5QdWJTdWJTZXJ2aWNlIH0gZnJvbSAnLi9uLXB1YlN1Yi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTkxvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tbG9jYWxTdG9yYWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBOTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4vbi1ub3RpZmljYXRpb24uc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTkxvZ2luU2VydmljZSB7XHJcbiAgbG9naW5Vcmw7XHJcbiAgYXBwUHJvcGVydGllcztcclxuICBzeXN0ZW1TZXJ2aWNlO1xyXG4gIG5TZXNzaW9uU3RvcmFnZTtcclxuICB1dWlkO1xyXG4gIGRldGFpbHM6IGFueTtcclxuXHJcbiAgQE91dHB1dCgpIGxvZ2luQ29tcGxldGVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSBwdWJTdWJTZXJ2aWNlOiBOUHViU3ViU2VydmljZSwgcHJpdmF0ZSBub3RpZmljYXRpb25TZXJ2aWNlOiBOTm90aWZpY2F0aW9uU2VydmljZSxcclxuICAgIHByaXZhdGUgbkxvY2FsU3RvcmFnZVNlcnZpY2U6IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLCBwcml2YXRlIG5Ub2tlblNlcnZpY2U6IE5Ub2tlblNlcnZpY2UpIHtcclxuICAgIHRoaXMuc3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XHJcbiAgICAvLyB0aGlzLm5Ub2tlblNlcnZpY2UgPSBuZXcgTlRva2VuU2VydmljZSgpO1xyXG4gICAgdGhpcy5uU2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xyXG4gICAgLy8gdGhpcy5uTG9jYWxTdG9yYWdlU2VydmljZSA9IG5ldyBOTG9jYWxTdG9yYWdlU2VydmljZSgpO1xyXG4gIH1cclxuXHJcblxyXG4gIGxvZ2luKHVzZXJOYW1lLCBwYXNzd29yZCwgaXNSZW1lbWJlcj8pIHtcclxuICAgIHRoaXMuYXBwUHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3Byb3BlcnRpZXMnKTtcclxuICAgIHRoaXMubG9naW5VcmwgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0QXV0aFVybCgpICsgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcE5hbWU7XHJcbiAgICB0aGlzLnV1aWQgPSB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyk7XHJcbiAgICBpZiAoIXRoaXMudXVpZCkge1xyXG4gICAgICB0aGlzLnV1aWQgPSB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmNoZWNrRGV2aWNlSWQoKTtcclxuICAgIH1cclxuICAgIHRoaXMuZGV0YWlscyA9IHtcclxuICAgICAgdXNlcm5hbWU6IHVzZXJOYW1lLFxyXG4gICAgICBwYXNzd29yZDogcGFzc3dvcmQsXHJcbiAgICB9O1xyXG4gICAgdGhpcy5kZXRhaWxzLnBsYXRmb3JtRGV0YWlscyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRQbGF0Zm9ybURldGFpbHModGhpcy5zeXN0ZW1TZXJ2aWNlLmNoZWNrRGV2aWNlKCkpO1xyXG4gICAgdGhpcy5kZXRhaWxzLnBsYXRmb3JtRGV0YWlsc1sndXVpZCddID0gdGhpcy51dWlkO1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHRoaXMubG9naW5VcmwsIEpTT04uc3RyaW5naWZ5KHRoaXMuZGV0YWlscykpLnBpcGUobWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgIGNvbnN0IHRva2Vuc09iaiA9IHJlc3VsdDtcclxuICAgICAgaWYgKHRva2Vuc09iaikge1xyXG4gICAgICAgIHRoaXMublRva2VuU2VydmljZS51cGRhdGVUb2tlbnModG9rZW5zT2JqLCBpc1JlbWVtYmVyKTtcclxuICAgICAgfVxyXG4gICAgICAvLyBUT0RPIGNocmlzIGFycmF5IG9mIHN1cHBvcnRlZCBwdXNoZXMgY3VycmVudGx5IG9ubHkgc3VwcG9ydCBBUE5TIGFuZCBGaXJlYmFzZVxyXG4gICAgICBpZiAoKHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2ZpcmViYXNlU2VuZGVySWQnKSAhPSAnRklSRUJBU0VfU0VOREVSX0lEJyAmJiB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdmaXJlYmFzZUF1dGhLZXknKSAhPSAnRklSRUJBU0VfQVVUSF9LRVknKSBcclxuICAgICAgICAgICB8fCAodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSA9PT0gJ0FQTlMnICYmIHRoaXMuc3lzdGVtU2VydmljZS5pc0lPUygpKSkge1xyXG4gICAgICAgIHRoaXMucHViU3ViU2VydmljZS4kcHViKCdmaXJlYmFzZVJlZ2lzdGVyJyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5wdWJTdWJTZXJ2aWNlLiRwdWIoJ2xvZ2luQ29tcGxldGUnKTtcclxuICAgICAgcmV0dXJuIChyZXN1bHQpO1xyXG4gICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICByZXR1cm4gKGVycm9yKTtcclxuICAgIH0pKTtcclxuICB9XHJcblxyXG4gIGlzTG9nZ2VkSW4oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uTG9jYWxTdG9yYWdlU2VydmljZS5pbml0U3RvcmFnZSgpLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgaWYgKHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdhY2Nlc3NUb2tlbicpICYmIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdyZWZyZXNoVG9rZW4nKSAmJlxyXG4gICAgICAgIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdhY2Nlc3NUb2tlbicpICE9ICdudWxsJyAmJiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgncmVmcmVzaFRva2VuJykgIT0gJ251bGwnKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuXHJcbiAgfVxyXG59XHJcbiJdfQ==