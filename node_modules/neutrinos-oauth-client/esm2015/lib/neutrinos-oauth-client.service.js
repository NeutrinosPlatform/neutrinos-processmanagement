/**
 * @fileoverview added by tsickle
 * Generated from: lib/neutrinos-oauth-client.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Subject } from 'rxjs';
import { UtilService } from './services/util.service';
import * as i0 from "@angular/core";
import * as i1 from "./services/util.service";
import * as i2 from "@angular/common/http";
export class NeutrinosOAuthClientService {
    /**
     * @param {?} util
     * @param {?} http
     */
    constructor(util, http) {
        this.util = util;
        this.http = http;
        this.cookieName = 'connect.sid';
        this.authStateSubject = new Subject();
    }
    /**
     * Get user info and tokens of the current logged in user
     * @return {?}
     */
    get userInfo() {
        return this.currentUserInfo;
    }
    /**
     * @return {?}
     */
    get isLoggedIn() {
        return this.currentUserInfo ? true : false;
    }
    /**
     * @private
     * @param {?} userInfo
     * @return {?}
     */
    setUserInfo(userInfo) {
        this.currentUserInfo = userInfo;
    }
    /**
     * Performs authentication based on configuration and returns user info for mobile env and
     * for web app user info is stored in memory. Call userInfo getter method to retrieve userinfo
     * @param {?=} redirectBackUrl - url to redirect back to when authentication is done. Valid only for Web.
     * For mobile use the Promise returned to perform post authentication actions
     * @return {?}
     */
    login(redirectBackUrl) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (this.util.getEnvValue('isIDSEnabled') === 'false') {
                return reject({ message: 'IDS is not enabled in environments' });
            }
            if (this.util.getPlatformType() === 'browser') {
                this.loginWithRedirect(redirectBackUrl);
                return;
            }
            this.loginWithInAppBrowser()
                .then((/**
             * @param {?} tokenset
             * @return {?}
             */
            tokenset => {
                return resolve(tokenset);
            }))
                .catch((/**
             * @param {?} authError
             * @return {?}
             */
            authError => {
                return reject(authError);
            }));
        }));
    }
    /**
     *
     * @private
     * @return {?}
     */
    loginWithInAppBrowser() {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const scriptURLS = ['/interaction/', '/auth-provider/return'];
            // execute JS only for this urls
            /** @type {?} */
            const script = yield this.getScript();
            // Get JS which stores guid and device details in local storage of webview
            /** @type {?} */
            const inAppBrowserRef = cordova.InAppBrowser.open(this.util.getMobileLoginUrl(), '_blank');
            /** @type {?} */
            const executeScriptCB = (/**
             * @param {?} event
             * @return {?}
             */
            (event) => {
                if (event && event.hasOwnProperty('type') && event.hasOwnProperty('url') && event.type === 'loadstop'
                    && this.isURLMatch(event.url, scriptURLS)) {
                    inAppBrowserRef.executeScript({ code: script }, (/**
                     * @return {?}
                     */
                    () => { }));
                }
            });
            inAppBrowserRef.addEventListener('loadstop', executeScriptCB);
            /** @type {?} */
            const exitCB = (/**
             * @return {?}
             */
            () => {
                return reject({ code: 'auth-cancel', message: 'Authentication cancelled by user' });
            });
            inAppBrowserRef.addEventListener('message', (/**
             * @param {?} message
             * @return {?}
             */
            (message) => {
                if (message && message.data && message.data.auth && message.data.auth === 'success') {
                    inAppBrowserRef.removeEventListener('exit', exitCB);
                    inAppBrowserRef.close();
                    this.persistCookies();
                    this.getUserInfo().then((/**
                     * @param {?} tokenset
                     * @return {?}
                     */
                    tokenset => {
                        return resolve(tokenset);
                    })).catch((/**
                     * @param {?} authErr
                     * @return {?}
                     */
                    authErr => {
                        return reject(authErr);
                    }));
                }
            }));
            // settle the promise if user closed the in app browser manually
            inAppBrowserRef.addEventListener('exit', exitCB);
        })));
    }
    /**
     * @private
     * @param {?} url
     * @param {?} compareWith
     * @return {?}
     */
    isURLMatch(url, compareWith) {
        return compareWith.some((/**
         * @param {?} u
         * @return {?}
         */
        u => url.includes(u)));
    }
    /**
     * Returns JS as a string to be executed in inAppBrowser which sets guid and device details in localStorage
     * @private
     * @return {?}
     */
    getScript() {
        return __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const deviceDetails = JSON.stringify(window['device']) || {};
            /** @type {?} */
            const guid = yield this.getuniqueDeviceID();
            /** @type {?} */
            const guidScript = guid ? `localStorage.setItem('guid', '${guid}')` : '';
            /** @type {?} */
            const script = `${guidScript}
          localStorage.setItem('additionalInfo', '${deviceDetails}')
          window.isScriptExecuted = true;`;
            return script;
        });
    }
    /**
     * @private
     * @return {?}
     */
    getuniqueDeviceID() {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            window['plugins'].uniqueDeviceID.get((/**
             * @param {?} guid
             * @return {?}
             */
            (guid) => {
                return resolve(guid);
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                return resolve(null);
            }));
        }));
    }
    /**
     * @return {?}
     */
    getUserInfo() {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            /** @type {?} */
            let headers = new HttpHeaders();
            /*Edge case: Userinfo is retreived from cache when login page is opened and user cancels the login attempt  */
            headers = headers.set('Cache-Control', 'no-cache');
            headers = headers.set('Pragma', 'no-cache');
            this.http.get(this.util.getUserInfoUrl(), { headers }).subscribe((/**
             * @param {?} tokenset
             * @return {?}
             */
            tokenset => {
                this.setUserInfo(tokenset);
                return resolve(tokenset);
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                this.destroyClientSession();
                return reject(error);
            }));
        }));
    }
    /*If SSD throws 401 during any http request due to refresh token expiry, cookie expiry or access revoke nullify the userinfo in memory
      and emit authState event  */
    /**
     * @param {?} errorResponse
     * @return {?}
     */
    removeUserInfo(errorResponse) {
        this.destroyClientSession();
        this.authStateSubject.next(errorResponse);
    }
    /**
     * Returns event when Auth state has changed due to session expiry, access revoke or cookie expiry.
     * @return {?}
     */
    authState() {
        return this.authStateSubject.asObservable();
    }
    /**
     * @private
     * @param {?} redirectBackUrl
     * @return {?}
     */
    loginWithRedirect(redirectBackUrl) {
        window.location.href = this.util.getWebLoginUrl(redirectBackUrl);
    }
    /**
     * Persists cookies in localStorage to be used during next app launch only for IOS
     * @private
     * @return {?}
     */
    persistCookies() {
        if (window['device'] && window['device'].platform === 'iOS') {
            this.getCookie(this.cookieName, this.util.getSSDBasePath())
                .then((/**
             * @param {?} connectSid
             * @return {?}
             */
            connectSid => {
                localStorage.setItem('connectSid', connectSid);
            }));
        }
    }
    /**
     * Restores the connect.sid cookie from session storage during app bootstrap if device is mobile
     * @return {?}
     */
    restoreCookies() {
        return __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const connectSidCookie = localStorage.getItem('connectSid');
            if (!connectSidCookie) {
                return false;
            }
            return yield this.setCookie(this.util.getSSDBasePath(), this.cookieName, connectSidCookie);
        });
    }
    /**
     *
     * @private
     * @param {?} url - site where the cookie is stored
     * @param {?} cookieName - name of the cookie to restore
     * @param {?} cookieValue - value of the cookie to restore
     * @return {?}
     */
    setCookie(url, cookieName, cookieValue) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            cookieMaster.setCookieValue(url, cookieName, cookieValue, (/**
             * @return {?}
             */
            () => {
                return resolve(true);
            }), (/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                return reject(error);
            }));
        }));
    }
    /**
     *
     * @private
     * @param {?} cookieName - name of the cookie to retrieve
     * @param {?} url - site where the cookie is stored
     * @return {?}
     */
    getCookie(cookieName, url) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            cookieMaster.getCookieValue(url, cookieName, (/**
             * @param {?} cookie
             * @return {?}
             */
            (cookie) => {
                return resolve(cookie.cookieValue);
            }), (/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                return reject(error);
            }));
        }));
    }
    /**
     * Logout the current user, destroys session between client and server.
     * @param {?=} redirectBackUrl - URL where the user is navigated post logout. Valid only for Web.
     * For mobile use the Promise returned to perform post authentication actions
     * @return {?}
     */
    logout(redirectBackUrl) {
        /** @type {?} */
        const logoutUrl = (this.util.getPlatformType() === 'browser') ? this.util.getWebLogoutUrl(redirectBackUrl)
            : this.util.getMobileLogoutUrl();
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.http.get(logoutUrl).subscribe((/**
             * @param {?} idsLogoutInfo
             * @return {?}
             */
            idsLogoutInfo => {
                this.destroyIDSSession(idsLogoutInfo)
                    .then((/**
                 * @return {?}
                 */
                () => {
                    return resolve();
                }))
                    .catch((/**
                 * @param {?} logoutErr
                 * @return {?}
                 */
                logoutErr => {
                    return reject(logoutErr);
                }));
            }), (/**
             * @param {?} logoutError
             * @return {?}
             */
            logoutError => {
                return reject(logoutError);
            }));
        }));
    }
    /**
     * @private
     * @param {?} idsInfo
     * @return {?}
     */
    destroyIDSSession(idsInfo) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (idsInfo['sessionExists'] === false) {
                // No session present with SSD due to cookie expiry
                this.destroyClientSession();
                this.authStateSubject.next({ code: 'NO_SESSION', message: 'User session has already expired' });
                return resolve();
            }
            if (this.util.getPlatformType() === 'browser') {
                window.location.href = idsInfo['idsURL'];
            }
            else {
                this.logoutWithInappBrowser(idsInfo['idsURL'])
                    .then((/**
                 * @return {?}
                 */
                () => {
                    return resolve();
                }))
                    .catch((/**
                 * @param {?} sessionError
                 * @return {?}
                 */
                sessionError => {
                    return reject(sessionError);
                }));
            }
        }));
    }
    /**
     *
     * @private
     * @param {?} idsLogoutUrl - IDS logout url
     * Opens InApp browser and destroys the session
     * @return {?}
     */
    logoutWithInappBrowser(idsLogoutUrl) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            /** @type {?} */
            const exitCB = (/**
             * @return {?}
             */
            () => {
                return reject({ code: 'auth-cancel', message: 'Authentication cancelled by user' });
            });
            /** @type {?} */
            const inAppBrowserRef = cordova.InAppBrowser.open(idsLogoutUrl, '_blank');
            inAppBrowserRef.addEventListener('message', (/**
             * @param {?} message
             * @return {?}
             */
            (message) => {
                // Remove exit listener if script closed the in app browser
                if (message && message.data && message.data.auth && message.data.auth === 'success') {
                    inAppBrowserRef.removeEventListener('exit', exitCB);
                    inAppBrowserRef.close();
                    this.destroyClientSession();
                    return resolve();
                }
            }));
            // settle the promise if user closed the in app browser manually
            inAppBrowserRef.addEventListener('exit', exitCB);
        }));
    }
    /*Remove persisted cookies in local storage and nullify user info */
    /**
     * @private
     * @return {?}
     */
    destroyClientSession() {
        this.setUserInfo(null);
        window.localStorage.removeItem('connectSid');
    }
}
NeutrinosOAuthClientService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
NeutrinosOAuthClientService.ctorParameters = () => [
    { type: UtilService },
    { type: HttpClient }
];
/** @nocollapse */ NeutrinosOAuthClientService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NeutrinosOAuthClientService_Factory() { return new NeutrinosOAuthClientService(i0.ɵɵinject(i1.UtilService), i0.ɵɵinject(i2.HttpClient)); }, token: NeutrinosOAuthClientService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    NeutrinosOAuthClientService.prototype.cookieName;
    /**
     * @type {?}
     * @private
     */
    NeutrinosOAuthClientService.prototype.currentUserInfo;
    /**
     * @type {?}
     * @private
     */
    NeutrinosOAuthClientService.prototype.authStateSubject;
    /**
     * @type {?}
     * @private
     */
    NeutrinosOAuthClientService.prototype.util;
    /**
     * @type {?}
     * @private
     */
    NeutrinosOAuthClientService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV1dHJpbm9zLW9hdXRoLWNsaWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmV1dHJpbm9zLW9hdXRoLWNsaWVudC8iLCJzb3VyY2VzIjpbImxpYi9uZXV0cmlub3Mtb2F1dGgtY2xpZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7O0FBUXRELE1BQU0sT0FBTywyQkFBMkI7Ozs7O0lBT3RDLFlBQW9CLElBQWlCLEVBQVUsSUFBZ0I7UUFBM0MsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVk7UUFMdkQsZUFBVSxHQUFHLGFBQWEsQ0FBQztRQUczQixxQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBR3pDLENBQUM7Ozs7O0lBS0QsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7Ozs7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQzdDLENBQUM7Ozs7OztJQUVPLFdBQVcsQ0FBQyxRQUFRO1FBQzFCLElBQUksQ0FBQyxlQUFlLEdBQUcsUUFBUSxDQUFDO0lBQ2xDLENBQUM7Ozs7Ozs7O0lBUU0sS0FBSyxDQUFDLGVBQXdCO1FBQ25DLE9BQU8sSUFBSSxPQUFPOzs7OztRQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENB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QWUsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDO1lBQ3pFLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTOzs7O1lBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDdEQsMkRBQTJEO2dCQUMzRCxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtvQkFDbkYsZUFBZSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztvQkFDcEQsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUN4QixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztvQkFDNUIsT0FBTyxPQUFPLEVBQUUsQ0FBQztpQkFDbEI7WUFDSCxDQUFDLEVBQUMsQ0FBQztZQUNILGdFQUFnRTtZQUNoRSxlQUFlLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ25ELENBQUMsRUFBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7O0lBR08sb0JBQW9CO1FBQzFCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkIsTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDL0MsQ0FBQzs7O1lBeFJGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQVBRLFdBQVc7WUFGWCxVQUFVOzs7Ozs7OztJQVlqQixpREFBbUM7Ozs7O0lBQ25DLHNEQUF3Qjs7Ozs7SUFFeEIsdURBQXlDOzs7OztJQUU3QiwyQ0FBeUI7Ozs7O0lBQUUsMkNBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBVdGlsU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvdXRpbC5zZXJ2aWNlJztcclxuXHJcbmRlY2xhcmUgY29uc3QgY29yZG92YTtcclxuZGVjbGFyZSBjb25zdCBjb29raWVNYXN0ZXI7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZXV0cmlub3NPQXV0aENsaWVudFNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIGNvb2tpZU5hbWUgPSAnY29ubmVjdC5zaWQnO1xyXG4gIHByaXZhdGUgY3VycmVudFVzZXJJbmZvO1xyXG5cclxuICBwcml2YXRlIGF1dGhTdGF0ZVN1YmplY3QgPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHV0aWw6IFV0aWxTZXJ2aWNlLCBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCB1c2VyIGluZm8gYW5kIHRva2VucyBvZiB0aGUgY3VycmVudCBsb2dnZWQgaW4gdXNlclxyXG4gICAqL1xyXG4gIGdldCB1c2VySW5mbygpIHtcclxuICAgIHJldHVybiB0aGlzLmN1cnJlbnRVc2VySW5mbztcclxuICB9XHJcblxyXG4gIGdldCBpc0xvZ2dlZEluKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFVzZXJJbmZvID8gdHJ1ZSA6IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRVc2VySW5mbyh1c2VySW5mbykge1xyXG4gICAgdGhpcy5jdXJyZW50VXNlckluZm8gPSB1c2VySW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFBlcmZvcm1zIGF1dGhlbnRpY2F0aW9uIGJhc2VkIG9uIGNvbmZpZ3VyYXRpb24gYW5kIHJldHVybnMgdXNlciBpbmZvIGZvciBtb2JpbGUgZW52IGFuZFxyXG4gICAqIGZvciB3ZWIgYXBwIHVzZXIgaW5mbyBpcyBzdG9yZWQgaW4gbWVtb3J5LiBDYWxsIHVzZXJJbmZvIGdldHRlciBtZXRob2QgdG8gcmV0cmlldmUgdXNlcmluZm9cclxuICAgKiBAcGFyYW0gcmVkaXJlY3RCYWNrVXJsIC0gdXJsIHRvIHJlZGlyZWN0IGJhY2sgdG8gd2hlbiBhdXRoZW50aWNhdGlvbiBpcyBkb25lLiBWYWxpZCBvbmx5IGZvciBXZWIuXHJcbiAgICogRm9yIG1vYmlsZSB1c2UgdGhlIFByb21pc2UgcmV0dXJuZWQgdG8gcGVyZm9ybSBwb3N0IGF1dGhlbnRpY2F0aW9uIGFjdGlvbnNcclxuICAgKi9cclxuICBwdWJsaWMgbG9naW4ocmVkaXJlY3RCYWNrVXJsPzogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy51dGlsLmdldEVudlZhbHVlKCdpc0lEU0VuYWJsZWQnKSA9PT0gJ2ZhbHNlJykge1xyXG4gICAgICAgIHJldHVybiByZWplY3QoeyBtZXNzYWdlOiAnSURTIGlzIG5vdCBlbmFibGVkIGluIGVudmlyb25tZW50cycgfSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMudXRpbC5nZXRQbGF0Zm9ybVR5cGUoKSA9PT0gJ2Jyb3dzZXInKSB7XHJcbiAgICAgICAgdGhpcy5sb2dpbldpdGhSZWRpcmVjdChyZWRpcmVjdEJhY2tVcmwpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmxvZ2luV2l0aEluQXBwQnJvd3NlcigpXHJcbiAgICAgICAgLnRoZW4odG9rZW5zZXQgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUodG9rZW5zZXQpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGF1dGhFcnJvciA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGF1dGhFcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGxvZ2luVXJsIC0gTG9naW4gdXJsIHdoZXJlIFNTRCBpcyBob3N0ZWRcclxuICAgKi9cclxuICBwcml2YXRlIGxvZ2luV2l0aEluQXBwQnJvd3NlcigpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IHNjcmlwdFVSTFMgPSBbJy9pbnRlcmFjdGlvbi8nLCAnL2F1dGgtcHJvdmlkZXIvcmV0dXJuJ107IC8vIGV4ZWN1dGUgSlMgb25seSBmb3IgdGhpcyB1cmxzXHJcbiAgICAgIGNvbnN0IHNjcmlwdCA9IGF3YWl0IHRoaXMuZ2V0U2NyaXB0KCk7IC8vIEdldCBKUyB3aGljaCBzdG9yZXMgZ3VpZCBhbmQgZGV2aWNlIGRldGFpbHMgaW4gbG9jYWwgc3RvcmFnZSBvZiB3ZWJ2aWV3XHJcbiAgICAgIGNvbnN0IGluQXBwQnJvd3NlclJlZiA9IGNvcmRvdmEuSW5BcHBCcm93c2VyLm9wZW4odGhpcy51dGlsLmdldE1vYmlsZUxvZ2luVXJsKCksICdfYmxhbmsnKTtcclxuICAgICAgY29uc3QgZXhlY3V0ZVNjcmlwdENCID0gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50Lmhhc093blByb3BlcnR5KCd0eXBlJykgJiYgZXZlbnQuaGFzT3duUHJvcGVydHkoJ3VybCcpICYmIGV2ZW50LnR5cGUgPT09ICdsb2Fkc3RvcCdcclxuICAgICAgICAgICYmIHRoaXMuaXNVUkxNYXRjaChldmVudC51cmwsIHNjcmlwdFVSTFMpKSB7XHJcbiAgICAgICAgICBpbkFwcEJyb3dzZXJSZWYuZXhlY3V0ZVNjcmlwdCh7IGNvZGU6IHNjcmlwdCB9LCAoKSA9PiB7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaW5BcHBCcm93c2VyUmVmLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRzdG9wJywgZXhlY3V0ZVNjcmlwdENCKTtcclxuICAgICAgY29uc3QgZXhpdENCID0gKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiByZWplY3QoeyBjb2RlOiAnYXV0aC1jYW5jZWwnLCBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gY2FuY2VsbGVkIGJ5IHVzZXInIH0pO1xyXG4gICAgICB9O1xyXG4gICAgICBpbkFwcEJyb3dzZXJSZWYuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChtZXNzYWdlKSA9PiB7XHJcbiAgICAgICAgaWYgKG1lc3NhZ2UgJiYgbWVzc2FnZS5kYXRhICYmIG1lc3NhZ2UuZGF0YS5hdXRoICYmIG1lc3NhZ2UuZGF0YS5hdXRoID09PSAnc3VjY2VzcycpIHtcclxuICAgICAgICAgIGluQXBwQnJvd3NlclJlZi5yZW1vdmVFdmVudExpc3RlbmVyKCdleGl0JywgZXhpdENCKTtcclxuICAgICAgICAgIGluQXBwQnJvd3NlclJlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgdGhpcy5wZXJzaXN0Q29va2llcygpO1xyXG4gICAgICAgICAgdGhpcy5nZXRVc2VySW5mbygpLnRoZW4odG9rZW5zZXQgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh0b2tlbnNldCk7XHJcbiAgICAgICAgICB9KS5jYXRjaChhdXRoRXJyID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChhdXRoRXJyKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIC8vIHNldHRsZSB0aGUgcHJvbWlzZSBpZiB1c2VyIGNsb3NlZCB0aGUgaW4gYXBwIGJyb3dzZXIgbWFudWFsbHlcclxuICAgICAgaW5BcHBCcm93c2VyUmVmLmFkZEV2ZW50TGlzdGVuZXIoJ2V4aXQnLCBleGl0Q0IpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzVVJMTWF0Y2godXJsLCBjb21wYXJlV2l0aDogQXJyYXk8c3RyaW5nPikge1xyXG4gICAgcmV0dXJuIGNvbXBhcmVXaXRoLnNvbWUodSA9PiB1cmwuaW5jbHVkZXModSkpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgSlMgYXMgYSBzdHJpbmcgdG8gYmUgZXhlY3V0ZWQgaW4gaW5BcHBCcm93c2VyIHdoaWNoIHNldHMgZ3VpZCBhbmQgZGV2aWNlIGRldGFpbHMgaW4gbG9jYWxTdG9yYWdlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRTY3JpcHQoKSB7XHJcbiAgICBjb25zdCBkZXZpY2VEZXRhaWxzID0gSlNPTi5zdHJpbmdpZnkod2luZG93WydkZXZpY2UnXSkgfHwge307XHJcbiAgICBjb25zdCBndWlkID0gYXdhaXQgdGhpcy5nZXR1bmlxdWVEZXZpY2VJRCgpO1xyXG4gICAgY29uc3QgZ3VpZFNjcmlwdCA9IGd1aWQgPyBgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2d1aWQnLCAnJHtndWlkfScpYCA6ICcnO1xyXG4gICAgY29uc3Qgc2NyaXB0ID0gYCR7Z3VpZFNjcmlwdH1cclxuICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdhZGRpdGlvbmFsSW5mbycsICcke2RldmljZURldGFpbHN9JylcclxuICAgICAgICAgIHdpbmRvdy5pc1NjcmlwdEV4ZWN1dGVkID0gdHJ1ZTtgO1xyXG4gICAgcmV0dXJuIHNjcmlwdDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0dW5pcXVlRGV2aWNlSUQoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB3aW5kb3dbJ3BsdWdpbnMnXS51bmlxdWVEZXZpY2VJRC5nZXQoKGd1aWQpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShndWlkKTtcclxuICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXNvbHZlKG51bGwpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcblxyXG4gIHB1YmxpYyBnZXRVc2VySW5mbygpOiBQcm9taXNlPHt9PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBsZXQgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xyXG4gICAgICAvKkVkZ2UgY2FzZTogVXNlcmluZm8gaXMgcmV0cmVpdmVkIGZyb20gY2FjaGUgd2hlbiBsb2dpbiBwYWdlIGlzIG9wZW5lZCBhbmQgdXNlciBjYW5jZWxzIHRoZSBsb2dpbiBhdHRlbXB0ICAqL1xyXG4gICAgICBoZWFkZXJzID0gaGVhZGVycy5zZXQoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tY2FjaGUnKTtcclxuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuc2V0KCdQcmFnbWEnLCAnbm8tY2FjaGUnKTtcclxuICAgICAgdGhpcy5odHRwLmdldCh0aGlzLnV0aWwuZ2V0VXNlckluZm9VcmwoKSwgeyBoZWFkZXJzIH0pLnN1YnNjcmliZSh0b2tlbnNldCA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRVc2VySW5mbyh0b2tlbnNldCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmUodG9rZW5zZXQpO1xyXG4gICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95Q2xpZW50U2Vzc2lvbigpO1xyXG4gICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLypJZiBTU0QgdGhyb3dzIDQwMSBkdXJpbmcgYW55IGh0dHAgcmVxdWVzdCBkdWUgdG8gcmVmcmVzaCB0b2tlbiBleHBpcnksIGNvb2tpZSBleHBpcnkgb3IgYWNjZXNzIHJldm9rZSBudWxsaWZ5IHRoZSB1c2VyaW5mbyBpbiBtZW1vcnlcclxuICBhbmQgZW1pdCBhdXRoU3RhdGUgZXZlbnQgICovXHJcbiAgcHVibGljIHJlbW92ZVVzZXJJbmZvKGVycm9yUmVzcG9uc2UpIHtcclxuICAgIHRoaXMuZGVzdHJveUNsaWVudFNlc3Npb24oKTtcclxuICAgIHRoaXMuYXV0aFN0YXRlU3ViamVjdC5uZXh0KGVycm9yUmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBldmVudCB3aGVuIEF1dGggc3RhdGUgaGFzIGNoYW5nZWQgZHVlIHRvIHNlc3Npb24gZXhwaXJ5LCBhY2Nlc3MgcmV2b2tlIG9yIGNvb2tpZSBleHBpcnkuXHJcbiAgICovXHJcbiAgcHVibGljIGF1dGhTdGF0ZSgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuYXV0aFN0YXRlU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9naW5XaXRoUmVkaXJlY3QocmVkaXJlY3RCYWNrVXJsKTogdm9pZCB7XHJcbiAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHRoaXMudXRpbC5nZXRXZWJMb2dpblVybChyZWRpcmVjdEJhY2tVcmwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGVyc2lzdHMgY29va2llcyBpbiBsb2NhbFN0b3JhZ2UgdG8gYmUgdXNlZCBkdXJpbmcgbmV4dCBhcHAgbGF1bmNoIG9ubHkgZm9yIElPU1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcGVyc2lzdENvb2tpZXMoKSB7XHJcbiAgICBpZiAod2luZG93WydkZXZpY2UnXSAmJiB3aW5kb3dbJ2RldmljZSddLnBsYXRmb3JtID09PSAnaU9TJykge1xyXG4gICAgICB0aGlzLmdldENvb2tpZSh0aGlzLmNvb2tpZU5hbWUsIHRoaXMudXRpbC5nZXRTU0RCYXNlUGF0aCgpKVxyXG4gICAgICAgIC50aGVuKGNvbm5lY3RTaWQgPT4ge1xyXG4gICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2Nvbm5lY3RTaWQnLCBjb25uZWN0U2lkKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RvcmVzIHRoZSBjb25uZWN0LnNpZCBjb29raWUgZnJvbSBzZXNzaW9uIHN0b3JhZ2UgZHVyaW5nIGFwcCBib290c3RyYXAgaWYgZGV2aWNlIGlzIG1vYmlsZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhc3luYyByZXN0b3JlQ29va2llcygpIHtcclxuICAgIGNvbnN0IGNvbm5lY3RTaWRDb29raWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29ubmVjdFNpZCcpO1xyXG4gICAgaWYgKCFjb25uZWN0U2lkQ29va2llKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiBhd2FpdCB0aGlzLnNldENvb2tpZSh0aGlzLnV0aWwuZ2V0U1NEQmFzZVBhdGgoKSwgdGhpcy5jb29raWVOYW1lLCBjb25uZWN0U2lkQ29va2llKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHVybCAtIHNpdGUgd2hlcmUgdGhlIGNvb2tpZSBpcyBzdG9yZWRcclxuICAgKiBAcGFyYW0gY29va2llTmFtZSAtIG5hbWUgb2YgdGhlIGNvb2tpZSB0byByZXN0b3JlXHJcbiAgICogQHBhcmFtIGNvb2tpZVZhbHVlIC0gdmFsdWUgb2YgdGhlIGNvb2tpZSB0byByZXN0b3JlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRDb29raWUodXJsOiBzdHJpbmcsIGNvb2tpZU5hbWU6IHN0cmluZywgY29va2llVmFsdWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29va2llTWFzdGVyLnNldENvb2tpZVZhbHVlKHVybCwgY29va2llTmFtZSwgY29va2llVmFsdWUsICgpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgfSwgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSAgY29va2llTmFtZSAtIG5hbWUgb2YgdGhlIGNvb2tpZSB0byByZXRyaWV2ZVxyXG4gICAqIEBwYXJhbSAgIHVybCAtIHNpdGUgd2hlcmUgdGhlIGNvb2tpZSBpcyBzdG9yZWRcclxuICAgKi9cclxuICBwcml2YXRlIGdldENvb2tpZShjb29raWVOYW1lOiBzdHJpbmcsIHVybDogc3RyaW5nKTogYW55IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGNvb2tpZU1hc3Rlci5nZXRDb29raWVWYWx1ZSh1cmwsIGNvb2tpZU5hbWUsIChjb29raWUpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShjb29raWUuY29va2llVmFsdWUpO1xyXG4gICAgICB9LCAoZXJyb3IpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExvZ291dCB0aGUgY3VycmVudCB1c2VyLCBkZXN0cm95cyBzZXNzaW9uIGJldHdlZW4gY2xpZW50IGFuZCBzZXJ2ZXIuXHJcbiAgICogQHBhcmFtIHJlZGlyZWN0QmFja1VybCAtIFVSTCB3aGVyZSB0aGUgdXNlciBpcyBuYXZpZ2F0ZWQgcG9zdCBsb2dvdXQuIFZhbGlkIG9ubHkgZm9yIFdlYi5cclxuICAgKiBGb3IgbW9iaWxlIHVzZSB0aGUgUHJvbWlzZSByZXR1cm5lZCB0byBwZXJmb3JtIHBvc3QgYXV0aGVudGljYXRpb24gYWN0aW9uc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBsb2dvdXQocmVkaXJlY3RCYWNrVXJsPzogc3RyaW5nKTogUHJvbWlzZTx7fT4ge1xyXG4gICAgY29uc3QgbG9nb3V0VXJsID0gKHRoaXMudXRpbC5nZXRQbGF0Zm9ybVR5cGUoKSA9PT0gJ2Jyb3dzZXInKSA/IHRoaXMudXRpbC5nZXRXZWJMb2dvdXRVcmwocmVkaXJlY3RCYWNrVXJsKVxyXG4gICAgICA6IHRoaXMudXRpbC5nZXRNb2JpbGVMb2dvdXRVcmwoKTtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuaHR0cC5nZXQobG9nb3V0VXJsKS5zdWJzY3JpYmUoaWRzTG9nb3V0SW5mbyA9PiB7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95SURTU2Vzc2lvbihpZHNMb2dvdXRJbmZvKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5jYXRjaChsb2dvdXRFcnIgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGxvZ291dEVycik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfSwgbG9nb3V0RXJyb3IgPT4ge1xyXG4gICAgICAgIHJldHVybiByZWplY3QobG9nb3V0RXJyb3IpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkZXN0cm95SURTU2Vzc2lvbihpZHNJbmZvKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoaWRzSW5mb1snc2Vzc2lvbkV4aXN0cyddID09PSBmYWxzZSkge1xyXG4gICAgICAgIC8vIE5vIHNlc3Npb24gcHJlc2VudCB3aXRoIFNTRCBkdWUgdG8gY29va2llIGV4cGlyeVxyXG4gICAgICAgIHRoaXMuZGVzdHJveUNsaWVudFNlc3Npb24oKTtcclxuICAgICAgICB0aGlzLmF1dGhTdGF0ZVN1YmplY3QubmV4dCh7IGNvZGU6ICdOT19TRVNTSU9OJywgbWVzc2FnZTogJ1VzZXIgc2Vzc2lvbiBoYXMgYWxyZWFkeSBleHBpcmVkJyB9KTtcclxuICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLnV0aWwuZ2V0UGxhdGZvcm1UeXBlKCkgPT09ICdicm93c2VyJykge1xyXG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gaWRzSW5mb1snaWRzVVJMJ107XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5sb2dvdXRXaXRoSW5hcHBCcm93c2VyKGlkc0luZm9bJ2lkc1VSTCddKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5jYXRjaChzZXNzaW9uRXJyb3IgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KHNlc3Npb25FcnJvcik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKlxyXG4gICAqIEBwYXJhbSBpZHNMb2dvdXRVcmwgLSBJRFMgbG9nb3V0IHVybFxyXG4gICAqIE9wZW5zIEluQXBwIGJyb3dzZXIgYW5kIGRlc3Ryb3lzIHRoZSBzZXNzaW9uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2dvdXRXaXRoSW5hcHBCcm93c2VyKGlkc0xvZ291dFVybDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBjb25zdCBleGl0Q0IgPSAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdCh7IGNvZGU6ICdhdXRoLWNhbmNlbCcsIG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBjYW5jZWxsZWQgYnkgdXNlcicgfSk7XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbnN0IGluQXBwQnJvd3NlclJlZiA9IGNvcmRvdmEuSW5BcHBCcm93c2VyLm9wZW4oaWRzTG9nb3V0VXJsLCAnX2JsYW5rJyk7XHJcbiAgICAgIGluQXBwQnJvd3NlclJlZi5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKG1lc3NhZ2UpID0+IHtcclxuICAgICAgICAvLyBSZW1vdmUgZXhpdCBsaXN0ZW5lciBpZiBzY3JpcHQgY2xvc2VkIHRoZSBpbiBhcHAgYnJvd3NlclxyXG4gICAgICAgIGlmIChtZXNzYWdlICYmIG1lc3NhZ2UuZGF0YSAmJiBtZXNzYWdlLmRhdGEuYXV0aCAmJiBtZXNzYWdlLmRhdGEuYXV0aCA9PT0gJ3N1Y2Nlc3MnKSB7XHJcbiAgICAgICAgICBpbkFwcEJyb3dzZXJSZWYucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXhpdCcsIGV4aXRDQik7XHJcbiAgICAgICAgICBpbkFwcEJyb3dzZXJSZWYuY2xvc2UoKTtcclxuICAgICAgICAgIHRoaXMuZGVzdHJveUNsaWVudFNlc3Npb24oKTtcclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgLy8gc2V0dGxlIHRoZSBwcm9taXNlIGlmIHVzZXIgY2xvc2VkIHRoZSBpbiBhcHAgYnJvd3NlciBtYW51YWxseVxyXG4gICAgICBpbkFwcEJyb3dzZXJSZWYuYWRkRXZlbnRMaXN0ZW5lcignZXhpdCcsIGV4aXRDQik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qUmVtb3ZlIHBlcnNpc3RlZCBjb29raWVzIGluIGxvY2FsIHN0b3JhZ2UgYW5kIG51bGxpZnkgdXNlciBpbmZvICovXHJcbiAgcHJpdmF0ZSBkZXN0cm95Q2xpZW50U2Vzc2lvbigpIHtcclxuICAgIHRoaXMuc2V0VXNlckluZm8obnVsbCk7XHJcbiAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ2Nvbm5lY3RTaWQnKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==